<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ ì²´í—˜ë‹¨ í†µí•© í”Œë«í¼ - Experience Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .listing-card {
            transition: all 0.3s ease;
        }
        .listing-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        .site-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .site-coupang_eats { background-color: #6C3483; color: white; }
        .site-danggeun { background-color: #E74C3C; color: white; }
        .site-soomgo { background-color: #3498DB; color: white; }
        .site-today_deal { background-color: #27AE60; color: white; }
        .deadline-soon {
            color: #E74C3C;
            font-weight: 600;
        }
        .skeleton {
            background: linear-gradient(90deg, #1f2937 25%, #374151 50%, #1f2937 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">
    <!-- Header -->
    <header class="bg-gradient-to-r from-purple-900 to-indigo-900 py-6 px-4 shadow-lg">
        <div class="max-w-7xl mx-auto">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h1 class="text-4xl font-bold mb-2">ğŸ ì²´í—˜ë‹¨ í†µí•© í”Œë«í¼</h1>
                    <p class="text-gray-200">í•œêµ­ ì£¼ìš” ì²´í—˜ë‹¨ ì‚¬ì´íŠ¸ì˜ ê³µê³ ë¥¼ í•œê³³ì—ì„œ ë³´ì„¸ìš”</p>
                </div>
                <div class="text-right">
                    <p class="text-2xl font-bold text-yellow-400" id="totalCount">-</p>
                    <p class="text-sm text-gray-300">ì´ ê³µê³  ìˆ˜</p>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- Controls Section -->
        <div class="bg-gray-800 rounded-lg p-6 mb-8 shadow-lg">
            <!-- Site Filter -->
            <div class="mb-6">
                <h2 class="text-sm font-semibold text-gray-300 mb-3">ğŸ“ ì²´í—˜ë‹¨ ì‚¬ì´íŠ¸ í•„í„°</h2>
                <div class="flex flex-wrap gap-2">
                    <button onclick="filterBySite('all')" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition">
                        ì „ì²´ ë³´ê¸°
                    </button>
                    <button onclick="filterBySite('coupang_eats')" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition">
                        ğŸ” ì¿ íŒ¡ì´ì¸ 
                    </button>
                    <button onclick="filterBySite('danggeun')" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition">
                        ğŸš— ë‹¹ê·¼ë§ˆì¼“
                    </button>
                    <button onclick="filterBySite('soomgo')" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition">
                        ğŸ”§ ìˆ¨ê³ 
                    </button>
                    <button onclick="filterBySite('today_deal')" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition">
                        ğŸ¯ ì˜¤ëŠ˜ì˜ë”œ
                    </button>
                </div>
            </div>

            <!-- Category Filter -->
            <div class="mb-6">
                <h2 class="text-sm font-semibold text-gray-300 mb-3">ğŸ·ï¸ ì¹´í…Œê³ ë¦¬ í•„í„°</h2>
                <div id="categoryFilter" class="flex flex-wrap gap-2">
                    <button onclick="filterByCategory('all')" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition">
                        ëª¨ë“  ì¹´í…Œê³ ë¦¬
                    </button>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-3">
                <button onclick="refreshListings()" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition flex items-center gap-2">
                    ğŸ”„ ìƒˆë¡œê³ ì¹¨
                </button>
                <button onclick="triggerCrawl()" class="px-6 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg transition flex items-center gap-2">
                    ğŸ•·ï¸ í¬ë¡¤ë§ ì‹œì‘
                </button>
                <div class="ml-auto">
                    <p class="text-xs text-gray-400">ìµœê·¼ ì—…ë°ì´íŠ¸: <span id="lastUpdate">ë°©ê¸ˆ</span></p>
                </div>
            </div>
        </div>

        <!-- Listings Grid -->
        <div id="listingsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Skeletons (loading state) -->
            <div class="listing-card bg-gray-800 rounded-lg overflow-hidden shadow-lg">
                <div class="skeleton h-40 w-full"></div>
                <div class="p-4">
                    <div class="skeleton h-4 w-3/4 mb-3 rounded"></div>
                    <div class="skeleton h-3 w-full mb-2 rounded"></div>
                    <div class="skeleton h-3 w-2/3 rounded"></div>
                </div>
            </div>
            <div class="listing-card bg-gray-800 rounded-lg overflow-hidden shadow-lg">
                <div class="skeleton h-40 w-full"></div>
                <div class="p-4">
                    <div class="skeleton h-4 w-3/4 mb-3 rounded"></div>
                    <div class="skeleton h-3 w-full mb-2 rounded"></div>
                    <div class="skeleton h-3 w-2/3 rounded"></div>
                </div>
            </div>
            <div class="listing-card bg-gray-800 rounded-lg overflow-hidden shadow-lg">
                <div class="skeleton h-40 w-full"></div>
                <div class="p-4">
                    <div class="skeleton h-4 w-3/4 mb-3 rounded"></div>
                    <div class="skeleton h-3 w-full mb-2 rounded"></div>
                    <div class="skeleton h-3 w-2/3 rounded"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 py-6 px-4 mt-12 border-t border-gray-700">
        <div class="max-w-7xl mx-auto text-center text-gray-400 text-sm">
            <p>M-006 êµ­ë‚´ ì²´í—˜ë‹¨ í†µí•© í”Œë«í¼ | MVP v1.0 | ì‹¤ì‹œê°„ ë°ì´í„° ì œê³µ</p>
        </div>
    </footer>

    <script>
        let currentSiteFilter = 'all';
        let currentCategoryFilter = 'all';
        let allListings = [];
        let categories = new Set();

        // Initialize
        window.addEventListener('load', () => {
            loadCategories();
            loadListings();
        });

        async function loadCategories() {
            try {
                const res = await fetch('/api/experience/categories');
                const data = await res.json();
                const categoryFilter = document.getElementById('categoryFilter');

                categoryFilter.innerHTML = '<button onclick="filterByCategory(\'all\')" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition">ëª¨ë“  ì¹´í…Œê³ ë¦¬</button>';

                data.categories.forEach(cat => {
                    const btn = document.createElement('button');
                    btn.className = 'px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition';
                    btn.textContent = `ğŸ·ï¸ ${cat}`;
                    btn.onclick = () => filterByCategory(cat);
                    categoryFilter.appendChild(btn);
                });
            } catch (error) {
                console.error('ì¹´í…Œê³ ë¦¬ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        async function loadListings() {
            try {
                const params = new URLSearchParams();
                if (currentSiteFilter !== 'all') params.append('site', currentSiteFilter);
                if (currentCategoryFilter !== 'all') params.append('category', currentCategoryFilter);

                const res = await fetch(`/api/experience/listings?${params}`);
                const data = await res.json();
                allListings = data.data;

                renderListings();
                updateStats();
                updateLastUpdate();
            } catch (error) {
                console.error('ê³µê³  ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('listingsContainer').innerHTML =
                    '<div class="col-span-full text-center text-red-400 py-8">ê³µê³ ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</div>';
            }
        }

        function renderListings() {
            const container = document.getElementById('listingsContainer');

            if (allListings.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-gray-400 py-8">í•´ë‹¹í•˜ëŠ” ê³µê³ ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            const daysUntilDeadline = (deadline) => {
                const now = new Date();
                const deadlineDate = new Date(deadline);
                const diff = deadlineDate - now;
                const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
                return days;
            };

            const getSiteColor = (site) => {
                const colors = {
                    'coupang_eats': 'ğŸ”',
                    'danggeun': 'ğŸš—',
                    'soomgo': 'ğŸ”§',
                    'today_deal': 'ğŸ¯'
                };
                return colors[site] || 'ğŸ“Œ';
            };

            container.innerHTML = allListings.map((listing, idx) => {
                const days = daysUntilDeadline(listing.deadline);
                const isUrgent = days <= 3;

                return `
                    <div class="listing-card bg-gray-800 rounded-lg overflow-hidden shadow-lg hover:shadow-2xl">
                        <div class="h-40 bg-gradient-to-br from-gray-700 to-gray-900 flex items-center justify-center overflow-hidden">
                            <img src="${listing.image_url}" alt="${listing.title}" class="w-full h-full object-cover" onerror="this.src='https://via.placeholder.com/300x200?text=Experience'">
                        </div>

                        <div class="p-4">
                            <div class="flex items-start justify-between mb-2">
                                <span class="site-badge site-${listing.site}">${getSiteColor(listing.site)} ${listing.site.replace('_', ' ')}</span>
                                ${isUrgent ? '<span class="text-xs bg-red-600 text-white px-2 py-1 rounded font-semibold">â° ê¸´ê¸‰</span>' : ''}
                            </div>

                            <h3 class="text-lg font-bold mb-2 line-clamp-2 hover:text-blue-300">${listing.title}</h3>

                            <div class="mb-3 space-y-1 text-sm text-gray-300">
                                <p>ğŸ“ ${listing.category || 'ë¯¸ë¶„ë¥˜'}</p>
                                <p class="${isUrgent ? 'deadline-soon' : ''}">
                                    ğŸ“… ë§ˆê°: ${days}ì¼ ë‚¨ìŒ (${new Date(listing.deadline).toLocaleDateString('ko-KR')})
                                </p>
                                <p>ğŸ ${listing.reward || 'ë¯¸ì •'}</p>
                            </div>

                            <p class="text-sm text-gray-400 mb-4 line-clamp-2">${listing.description || ''}</p>

                            <a href="${listing.url}" target="_blank" class="block w-full text-center bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg transition font-semibold">
                                ìì„¸íˆ ë³´ê¸° â†’
                            </a>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function updateStats() {
            try {
                const res = await fetch('/api/experience/stats');
                const stats = await res.json();
                document.getElementById('totalCount').textContent = stats.total_listings;
            } catch (error) {
                console.error('í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        function updateLastUpdate() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            document.getElementById('lastUpdate').textContent = `${hours}:${minutes}`;
        }

        function filterBySite(site) {
            currentSiteFilter = site;
            loadListings();
        }

        function filterByCategory(category) {
            currentCategoryFilter = category;
            loadListings();
        }

        function refreshListings() {
            loadListings();
            updateStats();
        }

        async function triggerCrawl() {
            try {
                const btn = event.target.closest('button');
                const originalText = btn.innerHTML;
                btn.innerHTML = 'â³ í¬ë¡¤ë§ ì¤‘...';
                btn.disabled = true;

                const res = await fetch('/api/experience/crawl', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                const result = await res.json();

                if (result.status === 'success') {
                    loadListings();
                    alert(`âœ… í¬ë¡¤ë§ ì™„ë£Œ!\nì´ ${result.total_listings_found || 0}ê°œì˜ ê³µê³ ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.`);
                } else {
                    alert('âŒ í¬ë¡¤ë§ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }

                btn.innerHTML = originalText;
                btn.disabled = false;
            } catch (error) {
                console.error('í¬ë¡¤ë§ ì‹¤íŒ¨:', error);
                alert('âŒ í¬ë¡¤ë§ ìš”ì²­ ì‹¤íŒ¨');
                event.target.closest('button').disabled = false;
                event.target.closest('button').innerHTML = 'ğŸ•·ï¸ í¬ë¡¤ë§ ì‹œì‘';
            }
        }

        // Auto-refresh every 5 minutes
        setInterval(() => {
            console.log('ìë™ ìƒˆë¡œê³ ì¹¨...');
            loadListings();
        }, 5 * 60 * 1000);
    </script>
</body>
</html>
