<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#111827">
    <meta name="description" content="SoftFactory 결제 내역">
    <title>결제 내역 — SoftFactory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="api.js"></script>
    <link rel="stylesheet" href="../responsive-framework.css">
    <link rel="stylesheet" href="../accessibility.css">
    <link rel="stylesheet" href="platform-dashboard-ui.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .status-chip {
            display: inline-flex;
            align-items: center;
            border-radius: 9999px;
            padding: 0.2rem 0.65rem;
            font-size: 0.75rem;
            font-weight: 700;
        }
        .status-chip.ok { background: rgba(34,197,94,0.18); color: #86efac; }
        .status-chip.warn { background: rgba(234,179,8,0.18); color: #fde047; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 antialiased soft-shell">
    <a href="#main" class="skip-to-main sr-only">메인 콘텐츠로 이동</a>

    <div class="flex h-screen overflow-hidden">
        <aside class="w-64 soft-sidebar border-r border-slate-800 flex flex-col shrink-0">
            <div class="p-6 border-b border-slate-800">
                <div class="flex items-center gap-3">
                    <span class="text-2xl" aria-hidden="true">🏭</span>
                    <div>
                        <h1 class="font-bold text-white">SoftFactory</h1>
                        <p class="text-xs text-slate-400">Premium SaaS</p>
                    </div>
                </div>
            </div>
            <nav class="flex-1 p-6 space-y-2 overflow-y-auto" aria-label="사용자 네비게이션">
                <button class="hamburger" aria-label="네비게이션 메뉴 열기" type="button"><span></span><span></span><span></span></button>
                <a href="dashboard.html" class="soft-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-slate-800 transition">📊 대시보드</a>
                <a href="performance.html" class="soft-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-slate-800 transition">📈 성능 & ROI</a>
                <a href="billing.html" aria-current="page" class="soft-nav-link active flex items-center gap-3 px-4 py-2.5 rounded-lg transition">💳 결제 내역</a>
                <a href="profile.html" class="soft-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-slate-800 transition">👤 계정</a>
                <a href="admin.html" class="soft-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-slate-800 transition">⚙️ 관리자</a>

                <div class="my-6 border-t border-slate-800"></div>
                <p class="section-title text-xs font-semibold text-slate-400 uppercase px-4 mb-3">서비스</p>
                <a href="../sns-auto/index.html" class="soft-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-slate-800 transition">📱 SNS Auto</a>
                <a href="../review/index.html" class="soft-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-slate-800 transition">⭐ Review</a>
                <a href="../coocook/index.html" class="soft-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-slate-800 transition">🍳 CooCook</a>
                <a href="../ai-automation/index.html" class="soft-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-slate-800 transition">🤖 AI Automation</a>
                <a href="../webapp-builder/index.html" class="soft-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-slate-800 transition">💻 WebApp Builder</a>
            </nav>
            <div class="p-6 border-t border-slate-800 soft-user-panel">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-white" id="userName">Demo User</p>
                        <p class="text-xs text-slate-400" id="userEmail">demo@softfactory.com</p>
                    </div>
                    <button onclick="logout()" class="p-2 hover:bg-slate-800 rounded-lg transition" title="로그아웃" type="button">🚪</button>
                </div>
            </div>
        </aside>

        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="soft-topbar px-6 py-4 flex items-start justify-between gap-4 shrink-0">
                <div>
                    <h2 class="text-xl font-bold text-white">결제 내역</h2>
                    <p class="text-xs text-slate-400">구독 관리, 요금 변경, 결제 이력 조회</p>
                </div>
                <div class="flex items-center gap-3">
                    <button id="refreshBilling" type="button" class="soft-btn px-3 py-2 rounded-lg text-sm">새로고침</button>
                    <button id="planManage" type="button" class="soft-btn soft-btn-primary px-3 py-2 rounded-lg text-sm">요금제 관리</button>
                </div>
            </header>

            <main id="main" class="flex-1 overflow-y-auto soft-main space-y-6">
                <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <article class="soft-card p-5">
                        <p class="text-slate-400 text-xs mb-1">현재 요금제</p>
                        <p class="value" id="planName">-</p>
                    </article>
                    <article class="soft-card p-5">
                        <p class="text-slate-400 text-xs mb-1">월 이용료</p>
                        <p class="value" id="planAmount">-</p>
                    </article>
                    <article class="soft-card p-5">
                        <p class="text-slate-400 text-xs mb-1">다음 결제일</p>
                        <p class="value" id="nextBilling">-</p>
                    </article>
                </section>

                <section class="soft-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4">활성 구독</h3>
                    <div id="subscriptions" class="space-y-3">로딩 중...</div>
                </section>

                <section class="soft-card p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-white">결제 이력</h3>
                        <span class="text-xs text-slate-500">최신순</span>
                    </div>
                    <div class="soft-table-wrap">
                        <table class="soft-table text-sm w-full">
                            <thead>
                                <tr>
                                    <th class="text-left py-3 px-4">날짜</th>
                                    <th class="text-left py-3 px-4">상품</th>
                                    <th class="text-left py-3 px-4">금액</th>
                                    <th class="text-left py-3 px-4">상태</th>
                                    <th class="text-left py-3 px-4">영수증</th>
                                </tr>
                            </thead>
                            <tbody id="paymentRows">
                                <tr><td class="py-3 px-4 text-slate-400" colspan="5">로딩 중...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <script>
        const BILLING_FALLBACK = {
            current_plan: { name: 'Starter', price: 39000, interval: '월간' },
            next_billing_date: '2026-03-01',
            services: [
                {
                    id: 'svc-sns',
                    name: 'SNS Auto',
                    type: '구독형',
                    status: 'active',
                    price: 39000,
                    next_charge: '2026-03-01'
                },
                {
                    id: 'svc-review',
                    name: 'Review',
                    type: '건수제',
                    status: 'inactive',
                    price: 19800,
                    next_charge: '-'
                }
            ],
            invoices: [
                { id: 'inv-2026-01', date: '2026-01-01', product: 'SNS Auto', amount: 39000, status: 'paid' },
                { id: 'inv-2025-12', date: '2025-12-01', product: 'Review', amount: 12000, status: 'paid' }
            ]
        };

        function safeText(id, value, fallback) {
            const el = document.getElementById(id);
            if (!el) return;
            el.textContent = value == null ? fallback : value;
        }

        function formatWon(value) {
            const n = Number(value || 0);
            if (!Number.isFinite(n)) return '₩0';
            return '₩' + n.toLocaleString('ko-KR');
        }

        function formatDate(value) {
            if (!value) return '-';
            try {
                return new Date(value).toLocaleDateString('ko-KR');
            } catch {
                return value;
            }
        }

        function setStatusChipClass(status) {
            const s = (status || '').toLowerCase();
            if (s === 'active' || s === 'paid' || s === 'completed' || s === '현재') {
                return 'ok';
            }
            if (s === 'pending' || s === 'processing') {
                return 'warn';
            }
            return '';
        }

        function setUserInfo() {
            const user = getUser ? getUser() : null;
            if (user) {
                safeText('userName', user.name || 'Demo User');
                safeText('userEmail', user.email || 'demo@softfactory.com');
            }
        }

        function renderSubscriptions(payload) {
            const services = payload.services || [];
            const container = document.getElementById('subscriptions');
            if (!services.length) {
                container.innerHTML = '<p class="text-slate-400">등록된 구독이 없습니다.</p>';
                return;
            }

            container.innerHTML = services.map((item) => {
                const active = item.status === 'active' || item.is_active;
                const price = formatWon(item.price);
                const next = formatDate(item.next_charge || item.next_billing_date);
                const statusText = item.status || (active ? 'active' : 'inactive');
                const chipClass = setStatusChipClass(statusText);
                const chip = '<span class="status-chip ' + chipClass + '">' + statusText + '</span>';
                const btnText = active ? '해지하기' : '재구독';
                return (
                    '<div class="rounded-lg border border-slate-800 p-4 flex items-center justify-between gap-3">' +
                        '<div>' +
                            '<p class="font-semibold text-white">' + (item.name || '서비스') + '</p>' +
                            '<p class="text-sm text-slate-400">' + (item.type || '이용권') + ' · 다음 결제: ' + next + '</p>' +
                        '</div>' +
                        '<div class="text-right">' +
                            '<p class="text-white">' + price + '/' + (item.interval || '월') + '</p>' +
                            chip +
                        '</div>' +
                        '<button data-id="' + (item.id || item.subscription_id || '') + '" data-active="' + (active ? 'true' : 'false') + '" class="cancelBtn soft-btn px-3 py-2 rounded-lg text-sm" type="button">' + btnText + '</button>' +
                    '</div>'
                );
            }).join('');

            container.querySelectorAll('.cancelBtn').forEach((btn) => {
                btn.addEventListener('click', async () => {
                    const id = btn.getAttribute('data-id');
                    btn.disabled = true;
                    try {
                        const isActive = btn.getAttribute('data-active') === 'true';
                        if (typeof cancelSubscription === 'function' && isActive && id) {
                            await cancelSubscription(id);
                            if (window.showSuccess) {
                                showSuccess('해지 요청이 처리되었습니다.');
                            }
                        } else {
                            if (window.showError) {
                                showError(isActive ? '해지 API 호출에 실패했습니다.' : '데모 모드에서는 구독 상태만 반영됩니다.');
                            }
                        }
                        await loadBilling();
                    } catch (e) {
                        if (window.showError) {
                            showError('구독 처리 중 오류: ' + e.message);
                        }
                    } finally {
                        btn.disabled = false;
                    }
                });
            });
        }

        function renderBillingInfo(payload) {
            safeText('planName', payload.current_plan?.name || 'Starter');
            safeText('planAmount', formatWon(payload.current_plan?.price || payload.monthly_charge || 0));
            safeText('nextBilling', formatDate(payload.current_plan?.next_billing_date || payload.next_billing_date));
            renderSubscriptions(payload);
        }

        function renderPayments(payload) {
            const rows = payload.invoices || payload.items || payload.payments || [];
            const tbody = document.getElementById('paymentRows');
            if (!rows.length) {
                tbody.innerHTML = '<tr><td class="py-3 px-4 text-slate-400" colspan="5">결제 이력이 없습니다.</td></tr>';
                return;
            }
            tbody.innerHTML = rows.map((p) => {
                const status = p.status || 'paid';
                const chip = '<span class="status-chip ' + setStatusChipClass(status) + '">' + status + '</span>';
                return (
                    '<tr class="border-b border-slate-700">' +
                        '<td class="py-3 px-4">' + formatDate(p.date || p.created_at) + '</td>' +
                        '<td class="py-3 px-4">' + (p.product || p.name || '-') + '</td>' +
                        '<td class="py-3 px-4">' + formatWon(p.amount) + '</td>' +
                        '<td class="py-3 px-4">' + chip + '</td>' +
                        '<td class="py-3 px-4"><button type="button" class="soft-btn px-2 py-1 rounded-lg text-xs" data-id="' + (p.id || p.invoice_id || '') + '">조회</button></td>' +
                    '</tr>'
                );
            }).join('');
        }

        async function loadBilling() {
            let info = null;
            let history = null;

            try {
                if (typeof getBillingInfo === 'function') {
                    info = await getBillingInfo();
                }
            } catch (error) {
                info = null;
            }

            try {
                if (typeof getPaymentHistory === 'function') {
                    history = await getPaymentHistory(1);
                }
            } catch (error) {
                history = null;
            }

            renderBillingInfo(info || BILLING_FALLBACK);
            renderPayments(history || BILLING_FALLBACK);
        }

        if (typeof requireAuth === 'function') {
            requireAuth();
        }

        document.getElementById('refreshBilling').addEventListener('click', loadBilling);
        document.getElementById('planManage').addEventListener('click', () => {
            window.location.href = 'admin.html';
        });

        setUserInfo();
        loadBilling();
        setInterval(loadBilling, 120000);
    </script>
    <script src="../mobile-optimization.js" defer></script>
</body>
</html>
