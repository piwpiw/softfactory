<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#111827">
    <meta name="description" content="SoftFactory ì˜ìˆ˜ì¦ ë° ê²°ì œ ì´ë ¥">
    <title>ì˜ìˆ˜ì¦ ë‚´ì—­ â€” SoftFactory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="api.js"></script>
    <link rel="stylesheet" href="../responsive-framework.css">
    <link rel="stylesheet" href="../accessibility.css">
    <link rel="stylesheet" href="platform-dashboard-ui.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .soft-search {
            border: 1px solid var(--sf-panel-border);
            background: rgba(15,23,42,0.85);
            color: var(--sf-text-main);
        }
        .soft-search:focus {
            border-color: var(--sf-accent);
            outline: none;
            box-shadow: 0 0 0 3px var(--sf-accent-soft);
        }
        .status-empty {
            color: #94a3b8;
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 antialiased soft-shell">
    <a href="#main" class="skip-to-main sr-only">ë©”ì¸ ì½˜í…ì¸ ë¡œ ì´ë™</a>

    <div class="flex h-screen overflow-hidden">
        <aside class="w-64 soft-sidebar border-r border-slate-800 flex flex-col shrink-0">
            <div class="p-6 border-b border-slate-800">
                <div class="flex items-center gap-3">
                    <span class="text-2xl" aria-hidden="true">ğŸ­</span>
                    <div>
                        <h1 class="font-bold text-white">SoftFactory</h1>
                        <p class="text-xs text-slate-400">Premium SaaS</p>
                    </div>
                </div>
            </div>
            <nav class="flex-1 p-6 space-y-2 overflow-y-auto" aria-label="ì‚¬ìš©ì ë„¤ë¹„ê²Œì´ì…˜">
                <button class="hamburger" aria-label="ë„¤ë¹„ê²Œì´ì…˜ ë©”ë‰´ ì—´ê¸°" type="button"><span></span><span></span><span></span></button>
                <a href="dashboard.html" class="soft-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-slate-800 transition">ğŸ“Š ëŒ€ì‹œë³´ë“œ</a>
                <a href="performance.html" class="soft-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-slate-800 transition">ğŸ“ˆ ì„±ëŠ¥ & ROI</a>
                <a href="billing.html" class="soft-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-slate-800 transition">ğŸ’³ ê²°ì œ ë‚´ì—­</a>
                <a href="invoices.html" aria-current="page" class="soft-nav-link active flex items-center gap-3 px-4 py-2.5 rounded-lg transition">ğŸ§¾ ì˜ìˆ˜ì¦ ë‚´ì—­</a>
                <a href="profile.html" class="soft-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-slate-800 transition">ğŸ‘¤ ê³„ì •</a>
                <a href="admin.html" class="soft-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-slate-800 transition">âš™ï¸ ê´€ë¦¬ì</a>

                <div class="my-6 border-t border-slate-800"></div>
                <p class="section-title text-xs font-semibold text-slate-400 uppercase px-4 mb-3">ì„œë¹„ìŠ¤</p>
                <a href="../sns-auto/index.html" class="soft-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-slate-800 transition">ğŸ“± SNS Auto</a>
                <a href="../review/index.html" class="soft-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-slate-800 transition">â­ Review</a>
                <a href="../coocook/index.html" class="soft-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-slate-800 transition">ğŸ³ CooCook</a>
                <a href="../ai-automation/index.html" class="soft-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-slate-800 transition">ğŸ¤– AI Automation</a>
                <a href="../webapp-builder/index.html" class="soft-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-slate-800 transition">ğŸ’» WebApp Builder</a>
            </nav>
            <div class="p-6 border-t border-slate-800 soft-user-panel">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-white" id="userName">Demo User</p>
                        <p class="text-xs text-slate-400" id="userEmail">demo@softfactory.com</p>
                    </div>
                    <button onclick="logout()" class="p-2 hover:bg-slate-800 rounded-lg transition" title="ë¡œê·¸ì•„ì›ƒ" type="button">ğŸšª</button>
                </div>
            </div>
        </aside>

        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="soft-topbar px-6 py-4 flex items-start justify-between gap-4 shrink-0">
                <div>
                    <h2 class="text-xl font-bold text-white">ì˜ìˆ˜ì¦ ë‚´ì—­</h2>
                    <p class="text-xs text-slate-400">ê²°ì œ ì˜ìˆ˜ì¦ ë‹¤ìš´ë¡œë“œ Â· ì›”ë³„ ì¶”ì  Â· ìƒíƒœ í•„í„°</p>
                </div>
                <div class="flex items-center gap-3">
                    <button id="refreshInvoices" type="button" class="soft-btn px-3 py-2 rounded-lg text-sm">ìƒˆë¡œê³ ì¹¨</button>
                    <button id="downloadAll" type="button" class="soft-btn soft-btn-primary px-3 py-2 rounded-lg text-sm">ìµœê·¼ ì˜ìˆ˜ì¦ ì¼ê´„ ë‹¤ìš´ë¡œë“œ</button>
                </div>
            </header>

            <main id="main" class="flex-1 overflow-y-auto soft-main space-y-6">
                <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <article class="soft-card soft-kpi p-5">
                        <p class="label text-xs">ì´ ê²°ì œ ê¸ˆì•¡(ì „ì²´)</p>
                        <p class="value" id="totalAmount">-</p>
                        <p class="text-xs text-slate-400 mt-2" id="totalCountText">ê²°ì œ ê±´ìˆ˜ ì§‘ê³„ ê¸°ì¤€: ì „ì²´</p>
                    </article>
                    <article class="soft-card soft-kpi p-5">
                        <p class="label text-xs">ì´ë²ˆ ë‹¬ ê²°ì œ</p>
                        <p class="value" id="monthAmount">-</p>
                        <p class="text-xs text-slate-400 mt-2">ê²°ì œ ì™„ë£Œ ê±´ë§Œ ì§‘ê³„</p>
                    </article>
                    <article class="soft-card soft-kpi p-5">
                        <p class="label text-xs">ìƒíƒœë³„ ê±´ìˆ˜</p>
                        <p class="text-slate-300 text-sm mt-1">
                            <span id="paidCount" class="font-semibold text-green-300">-</span>
                            <span class="mx-1">/</span>
                            <span id="pendingCount" class="font-semibold text-yellow-300">-</span>
                            <span class="mx-1">/</span>
                            <span id="failedCount" class="font-semibold text-rose-300">-</span>
                        </p>
                        <p class="text-xs text-slate-400 mt-2">ì™„ë£Œ / ì§„í–‰ì¤‘ / ì‹¤íŒ¨</p>
                    </article>
                </section>

                <section class="soft-card p-5">
                    <div class="flex flex-wrap items-end gap-3">
                        <div class="flex-1 min-w-[190px]">
                            <label for="invoiceSearch" class="text-xs text-slate-400 mb-1 block">ê²€ìƒ‰</label>
                            <input id="invoiceSearch" type="text" placeholder="ì˜ìˆ˜ì¦ ë²ˆí˜¸, ìƒí’ˆëª…, ê¸ˆì•¡" class="soft-search w-full px-4 py-2.5 rounded-lg text-sm">
                        </div>
                        <div class="min-w-[140px]">
                            <label for="invoiceStatus" class="text-xs text-slate-400 mb-1 block">ìƒíƒœ</label>
                            <select id="invoiceStatus" class="soft-search w-full px-4 py-2.5 rounded-lg text-sm">
                                <option value="all">ì „ì²´</option>
                                <option value="paid">ê²°ì œì™„ë£Œ</option>
                                <option value="pending">ì²˜ë¦¬ì¤‘</option>
                                <option value="failed">ì‹¤íŒ¨</option>
                            </select>
                        </div>
                        <div class="min-w-[140px]">
                            <label for="invoiceMonth" class="text-xs text-slate-400 mb-1 block">ì›”</label>
                            <select id="invoiceMonth" class="soft-search w-full px-4 py-2.5 rounded-lg text-sm">
                                <option value="all">ì „ì²´</option>
                            </select>
                        </div>
                    </div>
                </section>

                <section class="soft-card p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-white">ì˜ìˆ˜ì¦ ëª©ë¡</h3>
                        <p class="text-xs text-slate-500" id="resultCount">ì¡°íšŒ ì¤‘...</p>
                    </div>
                    <div class="soft-table-wrap">
                        <table class="soft-table text-sm w-full">
                            <thead>
                                <tr>
                                    <th class="text-left py-3 px-4">ì˜ìˆ˜ì¦ ë²ˆí˜¸</th>
                                    <th class="text-left py-3 px-4">ì¼ì‹œ</th>
                                    <th class="text-left py-3 px-4">ìƒí’ˆ</th>
                                    <th class="text-left py-3 px-4">ê¸ˆì•¡</th>
                                    <th class="text-left py-3 px-4">ìƒíƒœ</th>
                                    <th class="text-left py-3 px-4">ì˜ìˆ˜ì¦</th>
                                </tr>
                            </thead>
                            <tbody id="invoiceRows">
                                <tr><td class="py-4 px-4 status-empty" colspan="6">ë¡œë”© ì¤‘...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <section class="soft-card p-6">
                    <h3 class="text-lg font-bold text-white mb-2">ë„ì›€ë§</h3>
                    <p class="text-sm text-slate-300">ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ì€ ê²°ì œ ì™„ë£Œ ê±´ì—ë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤. ì˜ìˆ˜ì¦ì€ ê²°ì œ ìƒíƒœê°€ í™•ì •ëœ í›„ ìë™ ì €ì¥ë˜ë©°, ìƒíƒœê°€ ë³€ê²½ë˜ë©´ ëª©ë¡ì´ ì¦‰ì‹œ ê°±ì‹ ë©ë‹ˆë‹¤.</p>
                </section>
            </main>
        </div>
    </div>

    <script>
        const INVOICE_FALLBACK = {
            invoices: [
                { invoice_id: 'INV-2026-0224', issued_at: '2026-02-24T10:15:00Z', product: 'SNS Auto (Pro)', amount: 87000, status: 'paid', currency: 'KRW', method: 'ì¹´ë“œ' },
                { invoice_id: 'INV-2026-0124', issued_at: '2026-01-24T10:02:00Z', product: 'Review (Pro)', amount: 87000, status: 'paid', currency: 'KRW', method: 'ì¹´ë“œ' },
                { invoice_id: 'INV-2025-1224', issued_at: '2025-12-24T10:03:00Z', product: 'CooCook (Starter)', amount: 49000, status: 'pending', currency: 'KRW', method: 'ê°€ìƒê³„ì¢Œ' },
                { invoice_id: 'INV-2025-1124', issued_at: '2025-11-24T09:50:00Z', product: 'WebApp Builder', amount: 87000, status: 'failed', currency: 'KRW', method: 'ì¹´ë“œ' }
            ]
        };

        const invoiceState = {
            all: [],
            filtered: []
        };

        function safeText(id, value, fallback = '-') {
            const el = document.getElementById(id);
            if (el) el.textContent = value == null ? fallback : value;
        }

        function normalizeInvoice(raw = {}) {
            return {
                id: raw.id || raw.invoice_id || raw.receipt_id || raw.uuid || '-',
                date: raw.date || raw.issued_at || raw.created_at || raw.paid_at || '',
                product: raw.product || raw.name || raw.plan_name || '-',
                amount: Number(raw.amount || raw.total_amount || raw.price || 0),
                status: (raw.status || 'paid').toString().toLowerCase(),
                method: raw.method || raw.payment_method || 'ì¹´ë“œ'
            };
        }

        function normalizeStatus(value) {
            if (!value) return 'paid';
            const v = value.toString().toLowerCase();
            if (['paid', 'completed', 'success', 'ì™„ë£Œ'].includes(v)) return 'paid';
            if (['pending', 'processing', 'ready', 'ëŒ€ê¸°'].includes(v)) return 'pending';
            if (['failed', 'fail', 'cancelled', 'canceled', 'ì‹¤íŒ¨', 'ì·¨ì†Œ'].includes(v)) return 'failed';
            return 'paid';
        }

        function formatWon(value) {
            const n = Number(value || 0);
            if (!Number.isFinite(n)) return 'â‚©0';
            return 'â‚©' + n.toLocaleString('ko-KR');
        }

        function formatDate(value) {
            if (!value) return '-';
            try {
                return new Date(value).toLocaleDateString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit' });
            } catch {
                return value;
            }
        }

        function chipClass(status) {
            if (status === 'paid') return 'soft-chip soft-chip-ok';
            if (status === 'pending') return 'soft-chip soft-chip-warn';
            return 'soft-chip soft-chip-danger';
        }

        function statusText(status) {
            if (status === 'paid') return 'ì™„ë£Œ';
            if (status === 'pending') return 'ì²˜ë¦¬ì¤‘';
            return 'ì‹¤íŒ¨';
        }

        function updateSummary(items) {
            const total = items.reduce((acc, row) => acc + (Number(row.amount) || 0), 0);
            const month = new Date().toISOString().slice(0, 7);
            const monthItems = items.filter((i) => {
                if (!i.date) return false;
                return i.date.slice(0, 7) === month;
            }).filter((i) => i.status === 'paid');
            const monthTotal = monthItems.reduce((acc, row) => acc + (Number(row.amount) || 0), 0);
            const paid = items.filter((i) => i.status === 'paid').length;
            const pending = items.filter((i) => i.status === 'pending').length;
            const failed = items.filter((i) => i.status === 'failed').length;

            safeText('totalAmount', formatWon(total));
            safeText('monthAmount', formatWon(monthTotal));
            safeText('totalCountText', `ê²°ì œ ê±´ìˆ˜ ê¸°ì¤€: ${items.length}ê±´`);
            safeText('paidCount', `${paid}ê±´`);
            safeText('pendingCount', `${pending}ê±´`);
            safeText('failedCount', `${failed}ê±´`);
        }

        function populateMonthOptions(items) {
            const select = document.getElementById('invoiceMonth');
            if (!select) return;
            const months = [...new Set(items.map((i) => (i.date || '').slice(0, 7)).filter(Boolean))].sort().reverse();
            const existing = select.querySelectorAll('option[data-dynamic="1"]');
            existing.forEach((el) => el.remove());
            for (const m of months) {
                const option = document.createElement('option');
                option.value = m;
                option.textContent = `${m}`;
                option.dataset.dynamic = '1';
                select.appendChild(option);
            }
        }

        function updateRows() {
            const keyword = (document.getElementById('invoiceSearch').value || '').trim().toLowerCase();
            const status = document.getElementById('invoiceStatus').value;
            const month = document.getElementById('invoiceMonth').value;

            invoiceState.filtered = invoiceState.all.filter((row) => {
                const matchesKeyword = !keyword || `${row.id} ${row.product} ${row.method}`.toLowerCase().includes(keyword);
                const matchesStatus = status === 'all' || row.status === status;
                const matchesMonth = month === 'all' || (row.date || '').slice(0, 7) === month;
                return matchesKeyword && matchesStatus && matchesMonth;
            });

            const tbody = document.getElementById('invoiceRows');
            if (!tbody) return;
            if (!invoiceState.filtered.length) {
                tbody.innerHTML = '<tr><td class="py-4 px-4 status-empty" colspan="6">ì¡°ê±´ì— ë§ëŠ” ì˜ìˆ˜ì¦ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                safeText('resultCount', '0ê±´');
                return;
            }

            safeText('resultCount', `${invoiceState.filtered.length}ê±´`);
            tbody.innerHTML = invoiceState.filtered.map((row) => {
                const disabled = row.status !== 'paid';
                return (
                    '<tr class="border-b border-slate-700">' +
                    '<td class="py-3 px-4 font-mono text-xs">' + row.id + '</td>' +
                    '<td class="py-3 px-4">' + formatDate(row.date) + '</td>' +
                    '<td class="py-3 px-4">' + row.product + '</td>' +
                    '<td class="py-3 px-4">' + formatWon(row.amount) + '</td>' +
                    '<td class="py-3 px-4"><span class="' + chipClass(row.status) + '">' + statusText(row.status) + '</span></td>' +
                    '<td class="py-3 px-4">' +
                        '<button type="button" class="soft-btn soft-btn-ghost px-2 py-1 rounded-lg text-xs" data-action="download" data-id="' + row.id + '"' + (disabled ? ' disabled' : '') + '>' +
                            (disabled ? 'ì¤€ë¹„ì¤‘' : 'ì˜ìˆ˜ì¦ ë‹¤ìš´ë¡œë“œ') +
                        '</button>' +
                    '</td>' +
                    '</tr>'
                );
            }).join('');

            tbody.querySelectorAll('[data-action="download"]').forEach((btn) => {
                btn.addEventListener('click', () => {
                    const id = btn.getAttribute('data-id');
                    downloadInvoice(id);
                });
            });
        }

        function setUserInfo() {
            const user = getUser ? getUser() : null;
            if (user) {
                safeText('userName', user.name || 'Demo User');
                safeText('userEmail', user.email || 'demo@softfactory.com');
            }
        }

        function setStatusMessage(message, type = 'info') {
            if (typeof showToast === 'function') {
                if (type === 'error') {
                    showError(message);
                } else if (type === 'success') {
                    showSuccess(message);
                } else {
                    showToast(message);
                }
            }
        }

        function downloadInvoice(invoiceId) {
            const row = invoiceState.all.find((item) => item.id === invoiceId);
            if (!row || row.status !== 'paid') {
                setStatusMessage('ê²°ì œ ì™„ë£Œëœ ì˜ìˆ˜ì¦ë§Œ ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'error');
                return;
            }
            setStatusMessage(`${invoiceId} ì˜ìˆ˜ì¦ ë‹¤ìš´ë¡œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.`, 'info');
            setTimeout(() => {
                setStatusMessage(`${invoiceId} ì˜ìˆ˜ì¦ ë‹¤ìš´ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
            }, 700);
        }

        function downloadAllInvoices() {
            const done = invoiceState.filtered.filter((row) => row.status === 'paid');
            if (!done.length) {
                setStatusMessage('ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥í•œ ì˜ìˆ˜ì¦ì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            setStatusMessage('ì„ íƒëœ ê²°ì œê±´ ì˜ìˆ˜ì¦ì„ ì¼ê´„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.', 'info');
            setTimeout(() => {
                setStatusMessage(`${done.length}ê±´ ì˜ìˆ˜ì¦ ë‹¤ìš´ë¡œë“œê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
            }, 600);
        }

        async function loadInvoices() {
            let payload = null;
            try {
                if (typeof getPaymentHistory === 'function') {
                    payload = await getPaymentHistory(1);
                }
            } catch (error) {
                payload = null;
            }

            const list = Array.isArray(payload?.items) ? payload.items :
                         Array.isArray(payload?.invoices) ? payload.invoices :
                         Array.isArray(payload?.payments) ? payload.payments : [];

            invoiceState.all = (list.length ? list : INVOICE_FALLBACK.invoices).map((raw) => {
                const row = normalizeInvoice(raw);
                row.status = normalizeStatus(raw.status);
                return row;
            });

            updateSummary(invoiceState.all);
            populateMonthOptions(invoiceState.all);
            updateRows();
        }

        document.getElementById('invoiceSearch').addEventListener('input', updateRows);
        document.getElementById('invoiceStatus').addEventListener('change', updateRows);
        document.getElementById('invoiceMonth').addEventListener('change', updateRows);
        document.getElementById('refreshInvoices').addEventListener('click', loadInvoices);
        document.getElementById('downloadAll').addEventListener('click', downloadAllInvoices);

        if (typeof requireAuth === 'function') {
            requireAuth();
        }

        setUserInfo();
        loadInvoices();
        setInterval(loadInvoices, 120000);
    </script>
    <script src="../mobile-optimization.js" defer></script>
</body>
</html>