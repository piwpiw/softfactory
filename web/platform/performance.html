<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#111827">
    <meta name="description" content="SoftFactory 성능 & ROI 대시보드">
    <title>성능 & ROI — SoftFactory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="api.js"></script>
    <link rel="stylesheet" href="../responsive-framework.css">
    <link rel="stylesheet" href="../accessibility.css">
    <link rel="stylesheet" href="platform-dashboard-ui.css">
    <style>body { font-family: 'Inter', sans-serif; }</style>
</head>
<body class="bg-slate-950 text-slate-100 antialiased soft-shell">
    <a href="#main" class="skip-to-main sr-only">메인 콘텐츠로 이동</a>
    <div class="flex h-screen overflow-hidden">
        <aside class="w-64 soft-sidebar border-r border-slate-800 flex flex-col shrink-0">
            <div class="p-6 border-b border-slate-800">
                <div class="flex items-center gap-3">
                    <span class="text-2xl" aria-hidden="true">🏭</span>
                    <div>
                        <h1 class="font-bold text-white">SoftFactory</h1>
                        <p class="text-xs text-slate-400">Premium SaaS</p>
                    </div>
                </div>
            </div>
            <nav class="flex-1 p-6 space-y-2 overflow-y-auto" aria-label="사용자 네비게이션">
                <button class="hamburger" aria-label="네비게이션 메뉴 열기" type="button"><span></span><span></span><span></span></button>
                <a href="dashboard.html" class="soft-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-slate-800 transition">📊 대시보드</a>
                <a href="performance.html" aria-current="page" class="soft-nav-link active flex items-center gap-3 px-4 py-2.5 rounded-lg transition">📈 성능 & ROI</a>
                <a href="billing.html" class="soft-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-slate-800 transition">💳 결제 내역</a>
                <a href="profile.html" class="soft-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-slate-800 transition">👤 계정</a>
                <a href="admin.html" class="soft-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-slate-800 transition">⚙️ 관리자</a>
                <div class="my-6 border-t border-slate-800"></div>
                <p class="section-title text-xs font-semibold text-slate-400 uppercase px-4 mb-3">서비스</p>
                <a href="../sns-auto/index.html" class="soft-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-slate-800 transition">📱 SNS Auto</a>
                <a href="../review/index.html" class="soft-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-slate-800 transition">⭐ Review</a>
                <a href="../coocook/index.html" class="soft-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-slate-800 transition">🍳 CooCook</a>
                <a href="../ai-automation/index.html" class="soft-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-slate-800 transition">🤖 AI Automation</a>
                <a href="../webapp-builder/index.html" class="soft-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-slate-800 transition">💻 WebApp Builder</a>
            </nav>
            <div class="p-6 border-t border-slate-800 soft-user-panel">
                <div class="flex items-center justify-between">
                    <div><p class="text-sm font-medium text-white" id="userName">Demo User</p><p class="text-xs text-slate-400" id="userEmail">demo@softfactory.com</p></div>
                    <button onclick="logout()" class="p-2 hover:bg-slate-800 rounded-lg transition" title="로그아웃" type="button">🚪</button>
                </div>
            </div>
        </aside>
        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="soft-topbar px-6 py-4 flex items-start justify-between gap-4 shrink-0">
                <div>
                    <h2 class="text-xl font-bold text-white">성능 & ROI</h2>
                    <p class="text-xs text-slate-400" id="perfUpdated">업데이트: -</p>
                </div>
                <div class="flex items-center gap-3"><button id="refreshPerf" type="button" class="soft-btn px-3 py-2 rounded-lg text-sm">새로고침</button></div>
            </header>
            <main id="main" class="flex-1 overflow-y-auto soft-main space-y-6">
                <section class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
                    <article class="soft-card soft-kpi p-6"><p class="label text-slate-400 text-sm font-medium mb-2">CPU</p><p class="value" id="kpiCpu">-</p><p class="text-xs text-slate-500 mt-2" id="kpiCpuNote">로딩 중...</p></article>
                    <article class="soft-card soft-kpi p-6"><p class="label text-slate-400 text-sm font-medium mb-2">메모리</p><p class="value" id="kpiMemory">-</p><p class="text-xs text-slate-500 mt-2" id="kpiMemoryNote">로딩 중...</p></article>
                    <article class="soft-card soft-kpi p-6"><p class="label text-slate-400 text-sm font-medium mb-2">총 요청</p><p class="value" id="kpiRequests">-</p><p class="text-xs text-slate-500 mt-2" id="kpiRequestsNote">로딩 중...</p></article>
                    <article class="soft-card soft-kpi p-6"><p class="label text-slate-400 text-sm font-medium mb-2">에러율</p><p class="value" id="kpiErrors">-</p><p class="text-xs text-slate-500 mt-2" id="kpiErrorsNote">로딩 중...</p></article>
                </section>
                <section class="grid grid-cols-1 xl:grid-cols-2 gap-6">
                    <article class="soft-card p-6"><h3 class="text-lg font-bold text-white mb-4">시스템 지표 추이</h3><div id="metricTrend" class="h-80"></div></article>
                    <article class="soft-card p-6"><h3 class="text-lg font-bold text-white mb-4">DB 상태</h3><div id="dbTable"></div></article>
                </section>
                <section class="soft-card p-6"><h3 class="text-lg font-bold text-white mb-4">비즈니스 요약</h3><div id="dbRows" class="space-y-2 text-sm text-slate-300"></div></section>
                <section class="soft-card p-6"><div class="flex items-center justify-between mb-4"><h3 class="text-lg font-bold text-white">최근 알림</h3><span class="text-xs text-slate-500">데이터 소스: /api/metrics/summary</span></div><ul id="alerts" class="space-y-2 text-sm text-slate-300"></ul></section>
            </main>
        </div>
    </div>
    <script>
        if (typeof requireAuth === 'function') { requireAuth(); }
        function getUserIdentity() {
            const user = getUser();
            if (user) {
                document.getElementById('userName').textContent = user.name || 'Demo User';
                document.getElementById('userEmail').textContent = user.email || 'demo@softfactory.com';
            }
        }
        const perfHistory = [];
        const timeHistory = [];
        let perfChart = null;

        function initChart() {
            perfChart = new ApexCharts(document.getElementById('metricTrend'), {
                chart: { type: 'line', height: 320, toolbar: { show: false }, animations: { enabled: false } },
                theme: { mode: 'dark' },
                stroke: { width: 2 },
                colors: ['#6366f1', '#22c55e'],
                series: [{ name: 'CPU %', data: [] }, { name: '메모리 %', data: [] }],
                xaxis: { categories: [], labels: { style: { colors: '#94a3b8' } } },
                yaxis: { labels: { style: { colors: '#94a3b8' } } },
                grid: { borderColor: '#1e293b' },
                tooltip: { theme: 'dark' }
            });
            perfChart.render();
        }

        const PERFORMANCE_FALLBACK = {
            system: {
                cpu_percent: 0,
                memory: { percent: 0, rss_mb: 0 },
                process_id: '-'
            },
            application: {
                requests_total: 0,
                errors_total: 0,
                error_rate: 0
            },
            database: {
                status: 'unknown',
                stats: { users: 0, payments: 0, ai_employees: 0, sns_posts: 0, campaigns: 0, bookings: 0 }
            },
            uptime: { human_readable: '0m' }
        };

        async function fetchJson(path) {
            try {
                const response = await apiFetch(path);
                return response && response.ok ? await response.json() : null;
            } catch {
                return null;
            }
        }

        async function fetchSummary() {
            const candidates = [
                '/api/metrics/summary',
                '/platform/metrics/summary',
                '/api/platform/metrics/summary'
            ];
            for (const path of candidates) {
                const data = await fetchJson(path);
                if (data) return data;
            }
            return PERFORMANCE_FALLBACK;
        }

        function setText(id, value) {
            const el = document.getElementById(id);
            if (el) el.textContent = value;
        }

        function renderSummary(summary) {
            if (!summary) {
                ['kpiCpu','kpiMemory','kpiRequests','kpiErrors'].forEach((id)=>setText(id,'No Data'));
                setText('kpiCpuNote','데이터 수집 실패');
                setText('kpiMemoryNote','데이터 수집 실패');
                setText('kpiRequestsNote','데이터 수집 실패');
                setText('kpiErrorsNote','데이터 수집 실패');
                document.getElementById('dbRows').innerHTML = '<p class="text-slate-400">요약 데이터를 불러오지 못했습니다.</p>';
                document.getElementById('dbTable').innerHTML = '<p class="text-slate-400">DB 상태를 불러오지 못했습니다.</p>';
                return;
            }

            const system = summary.system || {};
            const app = summary.application || {};
            const db = summary.database || {};
            const mem = system.memory || {};
            const now = new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            setText('perfUpdated', '업데이트: ' + now);

            const cpu = system.cpu_percent != null ? system.cpu_percent.toFixed(1) + '%' : '-';
            const memMb = mem.rss_mb != null ? mem.rss_mb + ' MB' : '-';
            const requests = app.requests_total != null ? app.requests_total.toLocaleString('ko-KR') : '-';
            const errRate = app.error_rate != null ? app.error_rate.toFixed(2) + '%' : '-';

            setText('kpiCpu', cpu);
            setText('kpiMemory', memMb);
            setText('kpiRequests', requests);
            setText('kpiErrors', errRate);
            setText('kpiCpuNote', system.process_id ? ('PID ' + system.process_id) : 'CPU 모니터링 중');
            setText('kpiMemoryNote', mem.percent != null ? ('메모리 사용률 ' + mem.percent.toFixed(1) + '%') : '메모리 모니터링 중');
            setText('kpiRequestsNote', '오류: ' + (app.errors_total || 0));
            setText('kpiErrorsNote', '업타임: ' + ((summary.uptime && summary.uptime.human_readable) || '-'));

            const health = (db.stats && db.stats.users != null) ? db.stats : {};
            const rows = [
                '<tr><td class="py-2 pr-4 text-slate-400">DB 상태</td><td class="py-2 text-slate-100">' + (db.status || '-') + '</td></tr>',
                '<tr><td class="py-2 pr-4 text-slate-400">사용자</td><td class="py-2 text-slate-100">' + (health.users || '-') + '</td></tr>',
                '<tr><td class="py-2 pr-4 text-slate-400">결제</td><td class="py-2 text-slate-100">' + (health.payments || '-') + '</td></tr>',
                '<tr><td class="py-2 pr-4 text-slate-400">캠페인</td><td class="py-2 text-slate-100">' + (health.campaigns || '-') + '</td></tr>',
                '<tr><td class="py-2 pr-4 text-slate-400">예약</td><td class="py-2 text-slate-100">' + (health.bookings || '-') + '</td></tr>'
            ];
            document.getElementById('dbTable').innerHTML = '<table class="w-full"><tbody>' + rows.join('') + '</tbody></table>';

            const dbSummary = [
                'DB 상태: ' + (db.status || 'unknown'),
                'AI 직원 수: ' + (health.ai_employees == null ? '-' : health.ai_employees),
                'SNS 게시글: ' + (health.sns_posts == null ? '-' : health.sns_posts)
            ];
            document.getElementById('dbRows').innerHTML = dbSummary.map((line) => '<p>• ' + line + '</p>').join('');

            if (system.cpu_percent != null && mem.percent != null) {
                perfHistory.push({ cpu: system.cpu_percent, mem: mem.percent, t: now });
                timeHistory.push(now);
                if (perfHistory.length > 20) { perfHistory.shift(); timeHistory.shift(); }
                perfChart.updateOptions({
                    series: [
                        { name: 'CPU %', data: perfHistory.map((x) => Number(x.cpu || 0).toFixed(2)) },
                        { name: '메모리 %', data: perfHistory.map((x) => Number(x.mem || 0).toFixed(2)) }
                    ],
                    xaxis: { categories: [...timeHistory] }
                });
            }

            const alerts = [];
            const alertsEl = document.getElementById('alerts');
            if ((system.cpu_percent || 0) > 85) alerts.push('⚠️ CPU 사용량이 높습니다.');
            if ((mem.percent || 0) > 85) alerts.push('⚠️ 메모리 사용률이 높습니다.');
            if ((app.error_rate || 0) > 2) alerts.push('⚠️ 최근 에러율이 2%를 초과했습니다.');
            if (!alerts.length) alerts.push('현재 주의 경고가 없습니다.');
            alertsEl.innerHTML = alerts.map((a) => '<li class="border border-slate-800 rounded-lg px-3 py-2">' + a + '</li>').join('');
        }

        async function refreshAll() { renderSummary(await fetchSummary()); }
        initChart();
        getUserIdentity();
        refreshAll();
        setInterval(refreshAll, 60000);
        document.getElementById('refreshPerf').addEventListener('click', refreshAll);
    </script>
    <script src="../mobile-optimization.js" defer></script>
</body>
</html>
