<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#111827">
    <meta name="description" content="SoftFactory 계정 설정">
    <title>계정 — SoftFactory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="api.js"></script>
    <link rel="stylesheet" href="../responsive-framework.css">
    <link rel="stylesheet" href="../accessibility.css">
    <link rel="stylesheet" href="platform-dashboard-ui.css">
    <style>body { font-family: 'Inter', sans-serif; }</style>
</head>
<body class="bg-slate-950 text-slate-100 antialiased soft-shell">
    <a href="#main" class="skip-to-main sr-only">메인 콘텐츠로 이동</a>

    <div class="flex h-screen overflow-hidden">
        <aside class="w-64 soft-sidebar border-r border-slate-800 flex flex-col shrink-0">
            <div class="p-6 border-b border-slate-800">
                <div class="flex items-center gap-3">
                    <span class="text-2xl" aria-hidden="true">🏭</span>
                    <div>
                        <h1 class="font-bold text-white">SoftFactory</h1>
                        <p class="text-xs text-slate-400">Premium SaaS</p>
                    </div>
                </div>
            </div>
            <nav class="flex-1 p-6 space-y-2 overflow-y-auto" aria-label="사용자 네비게이션">
                <button class="hamburger" aria-label="네비게이션 메뉴 열기" type="button"><span></span><span></span><span></span></button>
                <a href="dashboard.html" class="soft-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-slate-800 transition">📊 대시보드</a>
                <a href="performance.html" class="soft-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-slate-800 transition">📈 성능 & ROI</a>
                <a href="billing.html" class="soft-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-slate-800 transition">💳 결제 내역</a>
                <a href="profile.html" aria-current="page" class="soft-nav-link active flex items-center gap-3 px-4 py-2.5 rounded-lg transition">👤 계정</a>
                <a href="admin.html" class="soft-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-slate-800 transition">⚙️ 관리자</a>

                <div class="my-6 border-t border-slate-800"></div>
                <p class="section-title text-xs font-semibold text-slate-400 uppercase px-4 mb-3">서비스</p>
                <a href="../sns-auto/index.html" class="soft-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-slate-800 transition">📱 SNS Auto</a>
                <a href="../review/index.html" class="soft-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-slate-800 transition">⭐ Review</a>
                <a href="../coocook/index.html" class="soft-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-slate-800 transition">🍳 CooCook</a>
                <a href="../ai-automation/index.html" class="soft-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-slate-800 transition">🤖 AI Automation</a>
                <a href="../webapp-builder/index.html" class="soft-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-slate-800 transition">💻 WebApp Builder</a>
            </nav>
            <div class="p-6 border-t border-slate-800 soft-user-panel">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-white" id="userName">Demo User</p>
                        <p class="text-xs text-slate-400" id="userEmail">demo@softfactory.com</p>
                    </div>
                    <button onclick="logout()" class="p-2 hover:bg-slate-800 rounded-lg transition" title="로그아웃" type="button">🚪</button>
                </div>
            </div>
        </aside>

        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="soft-topbar px-6 py-4 flex items-start justify-between gap-4 shrink-0">
                <div>
                    <h2 class="text-xl font-bold text-white">계정 설정</h2>
                    <p class="text-xs text-slate-400">내 정보 수정 및 보안 설정</p>
                </div>
                <button id="refreshProfile" type="button" class="soft-btn px-3 py-2 rounded-lg text-sm">새로고침</button>
            </header>

            <main id="main" class="flex-1 overflow-y-auto soft-main space-y-6">
                <section class="grid grid-cols-1 xl:grid-cols-2 gap-6">
                    <article class="soft-card p-6">
                        <h3 class="text-lg font-bold text-white mb-5">기본 정보</h3>
                        <form id="profileForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">이름</label>
                                <input id="profileName" type="text" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2.5 text-white" placeholder="이름" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">이메일</label>
                                <input id="profileEmail" type="email" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2.5 text-white" placeholder="이메일" required>
                            </div>
                            <button type="submit" class="soft-btn px-6 py-2 rounded-lg text-sm">변경 저장</button>
                        </form>
                    </article>

                    <article class="soft-card p-6">
                        <h3 class="text-lg font-bold text-white mb-5">비밀번호 변경</h3>
                        <form id="passwordForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">현재 비밀번호</label>
                                <input id="currentPw" type="password" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2.5 text-white" placeholder="현재 비밀번호" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">새 비밀번호</label>
                                <input id="newPw" type="password" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2.5 text-white" placeholder="새 비밀번호" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">새 비밀번호 확인</label>
                                <input id="confirmPw" type="password" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2.5 text-white" placeholder="새 비밀번호 확인" required>
                            </div>
                            <button type="submit" class="soft-btn px-6 py-2 rounded-lg text-sm">변경하기</button>
                        </form>
                    </article>
                </section>

                <section class="soft-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4">계정 상태</h3>
                    <p id="profileStatus" class="text-sm text-slate-400">현재 상태를 불러오는 중입니다.</p>
                </section>
            </main>
        </div>
    </div>

    <script>
        const PROFILE_FALLBACK = {
            name: 'Demo User',
            email: 'demo@softfactory.com',
            status: '정상'
        };

        if (typeof requireAuth === 'function') {
            requireAuth();
        }

        function showMsg(success, message) {
            if (success && typeof window.showSuccess === 'function') {
                window.showSuccess(message);
                return;
            }
            if (!success && typeof window.showError === 'function') {
                window.showError(message);
                return;
            }
            alert(message);
        }

        function setButtonState(form, disabled, text) {
            const btn = form.querySelector('button[type="submit"]');
            if (!btn) return;
            btn.disabled = disabled;
            if (text) btn.textContent = text;
        }

        function normalizeProfileData(user) {
            return {
                name: (user && user.name) || PROFILE_FALLBACK.name,
                email: (user && user.email) || PROFILE_FALLBACK.email,
                status: (user && user.status) || PROFILE_FALLBACK.status
            };
        }

        function loadIdentity() {
            const rawUser = typeof getUser === 'function' ? getUser() : null;
            const user = normalizeProfileData(rawUser);
            document.getElementById('userName').textContent = user.name;
            document.getElementById('userEmail').textContent = user.email;
            document.getElementById('profileName').value = user.name;
            document.getElementById('profileEmail').value = user.email;
            document.getElementById('profileStatus').textContent = '로그인 계정: ' + user.email + ' (' + user.status + ')';
        }

        async function saveProfile(ev) {
            ev.preventDefault();
            const form = ev.currentTarget;
            const name = document.getElementById('profileName').value.trim();
            const email = document.getElementById('profileEmail').value.trim();

            if (!name || !email) {
                showMsg(false, '이름과 이메일을 입력하세요.');
                return;
            }

            setButtonState(form, true, '저장 중...');
            const payload = { name, email };
            try {
                const response = typeof apiFetch === 'function'
                    ? await apiFetch('/api/user/profile', {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    })
                    : { ok: false };

                if (!response.ok) {
                    throw new Error('api-failed');
                }
                showMsg(true, '기본 정보가 저장되었습니다.');
            } catch {
                const current = typeof getUser === 'function' ? getUser() : {};
                const next = { ...current, ...payload };
                localStorage.setItem('user', JSON.stringify(next));
                showMsg(true, '데모 모드: 로컬에 저장되었습니다.');
            } finally {
                loadIdentity();
                setButtonState(form, false, '변경 저장');
            }
        }

        async function changePassword(ev) {
            ev.preventDefault();
            const form = ev.currentTarget;
            const cur = document.getElementById('currentPw').value;
            const next = document.getElementById('newPw').value;
            const conf = document.getElementById('confirmPw').value;

            if (!cur || !next || !conf) {
                showMsg(false, '모든 필드를 입력하세요.');
                return;
            }
            if (next !== conf) {
                showMsg(false, '새 비밀번호 확인 값이 일치하지 않습니다.');
                return;
            }
            if (next.length < 8) {
                showMsg(false, '새 비밀번호는 8자 이상이어야 합니다.');
                return;
            }

            setButtonState(form, true, '변경 중...');
            try {
                const response = typeof apiFetch === 'function'
                    ? await apiFetch('/api/auth/change-password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ current_password: cur, new_password: next })
                    })
                    : { ok: false };

                if (!response.ok) {
                    throw new Error('api-failed');
                }
                showMsg(true, '비밀번호가 변경되었습니다.');
            } catch {
                showMsg(true, '데모 모드: 비밀번호 변경 요청은 로컬 화면에서만 확인됩니다.');
            } finally {
                setButtonState(form, false, '변경하기');
                form.reset();
            }
        }

        document.getElementById('profileForm').addEventListener('submit', saveProfile);
        document.getElementById('passwordForm').addEventListener('submit', changePassword);
        document.getElementById('refreshProfile').addEventListener('click', loadIdentity);

        loadIdentity();
    </script>
    <script src="../mobile-optimization.js" defer></script>
</body>
</html>
