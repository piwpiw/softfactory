<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#111827">
    <meta name="description" content="SoftFactory ì‚¬ìš©ëŸ‰ ë¶„ì„">
    <title>ì‚¬ìš©ëŸ‰ ë¶„ì„ â€” SoftFactory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="api.js"></script>
    <link rel="stylesheet" href="../responsive-framework.css">
    <link rel="stylesheet" href="../accessibility.css">
    <link rel="stylesheet" href="platform-dashboard-ui.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .soft-input {
            border: 1px solid var(--sf-panel-border);
            background: rgba(15,23,42,0.85);
            color: var(--sf-text-main);
        }
        .soft-input:focus {
            border-color: var(--sf-accent);
            outline: none;
            box-shadow: 0 0 0 3px var(--sf-accent-soft);
        }
        .usage-empty {
            color: #94a3b8;
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 antialiased soft-shell">
    <a href="#main" class="skip-to-main sr-only">ë©”ì¸ ì½˜í…ì¸ ë¡œ ì´ë™</a>

    <div class="flex h-screen overflow-hidden">
        <aside class="w-64 soft-sidebar border-r border-slate-800 flex flex-col shrink-0">
            <div class="p-6 border-b border-slate-800">
                <div class="flex items-center gap-3">
                    <span class="text-2xl" aria-hidden="true">ğŸ­</span>
                    <div>
                        <h1 class="font-bold text-white">SoftFactory</h1>
                        <p class="text-xs text-slate-400">Premium SaaS</p>
                    </div>
                </div>
            </div>
            <nav class="flex-1 p-6 space-y-2 overflow-y-auto" aria-label="ì‚¬ìš©ì ë„¤ë¹„ê²Œì´ì…˜">
                <button class="hamburger" aria-label="ë„¤ë¹„ê²Œì´ì…˜ ë©”ë‰´ ì—´ê¸°" type="button"><span></span><span></span><span></span></button>
                <a href="dashboard.html" class="soft-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-slate-800 transition">ğŸ“Š ëŒ€ì‹œë³´ë“œ</a>
                <a href="performance.html" class="soft-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-slate-800 transition">ğŸ“ˆ ì„±ëŠ¥ & ROI</a>
                <a href="billing.html" class="soft-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-slate-800 transition">ğŸ’³ ê²°ì œ ë‚´ì—­</a>
                <a href="invoices.html" class="soft-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-slate-800 transition">ğŸ§¾ ì˜ìˆ˜ì¦ ë‚´ì—­</a>
                <a href="profile.html" class="soft-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-slate-800 transition">ğŸ‘¤ ê³„ì •</a>
                <a href="admin.html" class="soft-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-slate-800 transition">âš™ï¸ ê´€ë¦¬ì</a>

                <div class="my-6 border-t border-slate-800"></div>
                <p class="section-title text-xs font-semibold text-slate-400 uppercase px-4 mb-3">ì„œë¹„ìŠ¤</p>
                <a href="../sns-auto/index.html" class="soft-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-slate-800 transition">ğŸ“± SNS Auto</a>
                <a href="../review/index.html" class="soft-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-slate-800 transition">â­ Review</a>
                <a href="../coocook/index.html" class="soft-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-slate-800 transition">ğŸ³ CooCook</a>
                <a href="../ai-automation/index.html" class="soft-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-slate-800 transition">ğŸ¤– AI Automation</a>
                <a href="../webapp-builder/index.html" class="soft-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg hover:bg-slate-800 transition">ğŸ’» WebApp Builder</a>
            </nav>
            <div class="p-6 border-t border-slate-800 soft-user-panel">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-white" id="userName">Demo User</p>
                        <p class="text-xs text-slate-400" id="userEmail">demo@softfactory.com</p>
                    </div>
                    <button onclick="logout()" class="p-2 hover:bg-slate-800 rounded-lg transition" title="ë¡œê·¸ì•„ì›ƒ" type="button">ğŸšª</button>
                </div>
            </div>
        </aside>

        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="soft-topbar px-6 py-4 flex items-start justify-between gap-4 shrink-0">
                <div>
                    <h2 class="text-xl font-bold text-white">ì‚¬ìš©ëŸ‰ ë¶„ì„</h2>
                    <p class="text-xs text-slate-400">ì„œë¹„ìŠ¤/API ì‚¬ìš©ëŸ‰ ì¶”ì´ì™€ ì§€í‘œ ê¸°ë°˜ ìš©ëŸ‰ ê´€ë¦¬</p>
                </div>
                <div class="flex items-center gap-3">
                    <select id="timePeriod" onchange="updateCharts()" class="soft-input px-4 py-2 rounded-lg text-sm">
                        <option value="7d">ìµœê·¼ 7ì¼</option>
                        <option value="30d" selected>ìµœê·¼ 30ì¼</option>
                        <option value="90d">ìµœê·¼ 90ì¼</option>
                        <option value="1y">ìµœê·¼ 1ë…„</option>
                    </select>
                </div>
            </header>

            <main id="main" class="flex-1 overflow-y-auto soft-main space-y-6">
                <section class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <article class="soft-card p-5">
                        <p class="label text-xs">ì´ ìš”ì²­</p>
                        <p class="value" id="totalRequests">-</p>
                        <p class="text-xs text-slate-400 mt-2" id="requestDelta">ê¸°ì¤€: ìµœê·¼ ì§‘ê³„</p>
                    </article>
                    <article class="soft-card p-5">
                        <p class="label text-xs">ì„±ê³µ ìš”ì²­</p>
                        <p class="value" id="successRequests">-</p>
                        <p class="text-xs text-slate-400 mt-2" id="successRate">ì„±ê³µë¥  ì§‘ê³„</p>
                    </article>
                    <article class="soft-card p-5">
                        <p class="label text-xs">í‰ê·  ì‘ë‹µì‹œê°„</p>
                        <p class="value" id="avgLatency">-</p>
                        <p class="text-xs text-slate-400 mt-2">ëª©í‘œ: 100ms ì´í•˜</p>
                    </article>
                    <article class="soft-card p-5">
                        <p class="label text-xs">ê°€ìš©ë¥ </p>
                        <p class="value" id="availability">-</p>
                        <p class="text-xs text-slate-400 mt-2">ì§€í‘œ ë°˜ì˜ ì£¼ê¸°: 1ë¶„</p>
                    </article>
                </section>

                <section class="soft-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4">ì„œë¹„ìŠ¤ë³„ ì‚¬ìš©ëŸ‰</h3>
                    <canvas id="serviceUsageChart" height="320"></canvas>
                </section>

                <section class="soft-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4">ì¼ë³„ ì‚¬ìš©ëŸ‰ ì¶”ì´</h3>
                    <canvas id="dailyUsageChart" height="280"></canvas>
                </section>

                <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <article class="soft-card p-6">
                        <h3 class="text-lg font-bold text-white mb-4">ìš”ì²­ ìœ í˜•ë³„ ë¶„í¬</h3>
                        <canvas id="requestTypeChart" height="280"></canvas>
                    </article>
                    <article class="soft-card p-6">
                        <h3 class="text-lg font-bold text-white mb-4">ê¸°ëŠ¥ë³„ ì‚¬ìš©ëŸ‰</h3>
                        <div id="featureRows" class="space-y-3"></div>
                    </article>
                </section>

                <section class="soft-card p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-white">ì‹œê°„ëŒ€ë³„ í”¼í¬</h3>
                        <p class="text-xs text-slate-500">KST ê¸°ì¤€</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <article class="bg-slate-800 border border-slate-700 rounded-lg p-4">
                            <p class="text-sm text-slate-400 mb-1">ìµœê³  êµ¬ê°„</p>
                            <p class="text-2xl font-bold text-indigo-300" id="peakWindow">-</p>
                            <p class="text-xs text-slate-500 mt-2" id="peakDetail">ì§‘ê³„ ëŒ€ê¸° ì¤‘</p>
                        </article>
                        <article class="bg-slate-800 border border-slate-700 rounded-lg p-4">
                            <p class="text-sm text-slate-400 mb-1">ìµœì € êµ¬ê°„</p>
                            <p class="text-2xl font-bold text-cyan-300" id="offWindow">-</p>
                            <p class="text-xs text-slate-500 mt-2" id="offDetail">ì§‘ê³„ ëŒ€ê¸° ì¤‘</p>
                        </article>
                        <article class="bg-slate-800 border border-slate-700 rounded-lg p-4">
                            <p class="text-sm text-slate-400 mb-1">í”¼í¬ ë³€ë™</p>
                            <p class="text-2xl font-bold text-amber-300" id="peakVariance">-</p>
                            <p class="text-xs text-slate-500 mt-2" id="varianceNote">ì§‘ê³„ ëŒ€ê¸° ì¤‘</p>
                        </article>
                    </div>
                </section>

                <section class="soft-card p-6 flex flex-wrap gap-3">
                    <button onclick="exportUsageData('csv')" class="soft-btn px-4 py-2 rounded-lg text-sm">CSV ë‚´ë³´ë‚´ê¸°</button>
                    <button onclick="exportUsageData('json')" class="soft-btn soft-btn-ghost px-4 py-2 rounded-lg text-sm">JSON ë‚´ë³´ë‚´ê¸°</button>
                </section>
            </main>
        </div>
    </div>

    <script>
        const USAGE_FALLBACK = {
            total: {
                requests: 1245,
                success: 1184,
                avgLatency: 45,
                availability: 99.9,
                featureData: [
                    { name: 'SNS Auto', value: 456, ratio: 36 },
                    { name: 'Review', value: 289, ratio: 23 },
                    { name: 'CooCook', value: 234, ratio: 19 },
                    { name: 'AI Auto', value: 189, ratio: 15 },
                    { name: 'WebApp Builder', value: 77, ratio: 7 }
                ],
                daily: {
                    labels: ['1ì¼', '5ì¼', '10ì¼', '15ì¼', '20ì¼', '25ì¼', '30ì¼'],
                    values: [35, 45, 42, 68, 55, 72, 65]
                },
                requestTypes: [
                    { name: 'GET', value: 645 },
                    { name: 'POST', value: 380 },
                    { name: 'PUT', value: 180 },
                    { name: 'DELETE', value: 40 }
                ],
                peak: { hour: '14:00', count: 182 },
                offPeak: { hour: '02:00', count: 18 },
                variance: 91.1
            }
        };

        let charts = {};
        let currentData = USAGE_FALLBACK;

        function safeText(id, value, fallback = '-') {
            const el = document.getElementById(id);
            if (el) el.textContent = value == null ? fallback : value;
        }

        function toDateLabel() {
            const p = document.getElementById('timePeriod').value;
            const now = new Date();
            const label = new Date(now.getFullYear(), now.getMonth(), 1).toLocaleDateString('ko-KR', { year: 'numeric', month: '2-digit' });
            return p === '1y' ? label + ' ê¸°ì¤€' : 'ìµœê·¼ ì§‘ê³„';
        }

        function createOrUpdateChart(id, config) {
            const el = document.getElementById(id);
            if (!el) return;
            if (charts[id]) charts[id].destroy();
            charts[id] = new Chart(el.getContext('2d'), config);
        }

        function renderUsageCards(data) {
            const total = data.total.requests || 0;
            const successRate = total ? Math.round((data.total.success / total) * 1000) / 10 : 0;
            safeText('totalRequests', `${total.toLocaleString()}ê±´`);
            safeText('successRequests', `${(data.total.success || 0).toLocaleString()}ê±´`);
            safeText('successRate', `ì„±ê³µë¥  ${successRate}%`);
            safeText('avgLatency', `${data.total.avgLatency || 0}ms`);
            safeText('availability', `${data.total.availability || 0}%`);
            safeText('requestDelta', toDateLabel());
            safeText('peakWindow', `${data.total.peak.hour} (${data.total.peak.count}ê±´)`);
            safeText('offWindow', `${data.total.offPeak.hour} (${data.total.offPeak.count}ê±´)`);
            safeText('peakVariance', `${data.total.variance}%`);
            safeText('varianceNote', `ìµœê³  êµ¬ê°„ ëŒ€ë¹„ ì €ì  ê¸°ì¤€`);
            safeText('offDetail', 'íŠ¸ë˜í”½ ìŒì˜ êµ¬ê°„');
            safeText('peakDetail', 'ë™ì‹œ ì ‘ì† ê³ ì  êµ¬ê°„');

            const features = document.getElementById('featureRows');
            features.innerHTML = data.total.featureData.map((item) => (
                '<div class="flex items-center justify-between">' +
                    '<span class="text-sm text-slate-300">' + item.name + '</span>' +
                    '<span class="text-sm font-bold text-slate-100">' + item.value.toLocaleString() + ' (' + item.ratio + '%)</span>' +
                '</div>' +
                '<div class="w-full bg-slate-700 rounded h-2">' +
                    '<div class="bg-indigo-500 h-2 rounded" style="width:' + item.ratio + '%"></div>' +
                '</div>'
            )).join('');
        }

        function renderCharts(data) {
            const featureLabels = data.total.featureData.map((i) => i.name);
            const featureValues = data.total.featureData.map((i) => i.value);
            const daily = data.total.daily;
            const requestTypes = data.total.requestTypes;

            createOrUpdateChart('serviceUsageChart', {
                type: 'doughnut',
                data: {
                    labels: featureLabels,
                    datasets: [{
                        data: featureValues,
                        backgroundColor: ['#ec4899', '#f59e0b', '#f97316', '#06b6d4', '#a78bfa']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#cbd5e1' } } }
                }
            });

            createOrUpdateChart('dailyUsageChart', {
                type: 'line',
                data: {
                    labels: daily.labels,
                    datasets: [{
                        label: 'ì¼ë³„ ìš”ì²­ ìˆ˜',
                        data: daily.values,
                        borderColor: '#818cf8',
                        backgroundColor: 'rgba(129,140,248,0.12)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#818cf8'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                        x: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } }
                    },
                    plugins: { legend: { labels: { color: '#94a3b8' } } }
                }
            });

            createOrUpdateChart('requestTypeChart', {
                type: 'bar',
                data: {
                    labels: requestTypes.map((x) => x.name),
                    datasets: [{
                        label: 'ìš”ì²­ ìˆ˜',
                        data: requestTypes.map((x) => x.value),
                        backgroundColor: ['#06b6d4', '#0ea5e9', '#0284c7', '#0f766e']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                        x: { grid: { color: 'transparent' }, ticks: { color: '#94a3b8' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function updateCharts() {
            const period = document.getElementById('timePeriod').value;
            // ì‹¤ì„œë¹„ìŠ¤ ì—°ê²° ì‹œì ì—ëŠ” APIì—ì„œ ê¸°ê°„ íŒŒë¼ë¯¸í„° ì²˜ë¦¬
            safeText('requestDelta', `ì„ íƒ ê¸°ê°„: ${period}`);
            renderUsageCards(currentData);
            renderCharts(currentData);
            if (typeof showToast === 'function') {
                showToast('ì‚¬ìš©ëŸ‰ ì°¨íŠ¸ê°€ ê°±ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        }

        function exportUsageData(format) {
            const payload = {
                generatedAt: new Date().toISOString(),
                period: document.getElementById('timePeriod').value,
                usage: currentData
            };
            if (format === 'json') {
                const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `usage-report-${new Date().toISOString().slice(0, 10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
                if (showToast) showToast('JSON ë‚´ë³´ë‚´ê¸° ì™„ë£Œ', 'success');
                return;
            }
            const lines = [];
            lines.push('ì„œë¹„ìŠ¤,ìš”ì²­ìˆ˜,ë¹„ìœ¨');
            currentData.total.featureData.forEach((item) => {
                lines.push(`${item.name},${item.value},${item.ratio}%`);
            });
            const blob = new Blob([lines.join('\\n')], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `usage-report-${new Date().toISOString().slice(0, 10)}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            if (showToast) showToast('CSV ë‚´ë³´ë‚´ê¸° ì™„ë£Œ', 'success');
        }

        function logout() {
            if (typeof clearAuthToken === 'function') clearAuthToken();
            window.location.href = 'login.html';
        }

        function setUserInfo() {
            const user = getUser ? getUser() : null;
            if (user) {
                safeText('userName', user.name || 'Demo User');
                safeText('userEmail', user.email || 'demo@softfactory.com');
            }
        }

        function loadUsageData() {
            // ê¸°ì¡´ APIê°€ ìˆìœ¼ë©´ /api/usage/summary í˜•íƒœë¡œ ì‰½ê²Œ í™•ì¥ ê°€ëŠ¥
            currentData = USAGE_FALLBACK;
            renderUsageCards(currentData);
            renderCharts(currentData);
        }

        if (typeof requireAuth === 'function') {
            requireAuth();
        }

        setUserInfo();
        loadUsageData();
    </script>
    <script src="../mobile-optimization.js" defer></script>
</body>
</html>
