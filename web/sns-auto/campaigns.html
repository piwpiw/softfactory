<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìº í˜ì¸ ê´€ë¦¬ â€” SNS Auto | SoftFactory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="../platform/api.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 antialiased">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside class="w-64 bg-slate-900 border-r border-slate-800 flex flex-col shrink-0">
            <div class="p-6 border-b border-slate-800">
                <a href="../platform/dashboard.html" class="flex items-center gap-3">
                    <span class="text-2xl">ğŸ­</span>
                    <div>
                        <h1 class="font-bold text-white text-sm">SoftFactory</h1>
                        <p class="text-xs text-slate-400">â† Back</p>
                    </div>
                </a>
            </div>
            <nav class="flex-1 p-6 space-y-2 overflow-y-auto">
                <p class="text-xs font-semibold text-slate-400 uppercase px-4 mb-3">ğŸ“± SNS Auto</p>
                <a href="index.html" class="flex items-center gap-3 px-4 py-2.5 rounded-lg text-slate-300 hover:bg-slate-800 transition">
                    <span>ğŸ“Š</span> ëŒ€ì‹œë³´ë“œ
                </a>
                <a href="accounts.html" class="flex items-center gap-3 px-4 py-2.5 rounded-lg text-slate-300 hover:bg-slate-800 transition">
                    <span>ğŸ”—</span> ê³„ì • ì—°ë™
                </a>
                <a href="create.html" class="flex items-center gap-3 px-4 py-2.5 rounded-lg text-slate-300 hover:bg-slate-800 transition">
                    <span>âœï¸</span> í¬ìŠ¤íŠ¸ ì‘ì„±
                </a>
                <a href="schedule.html" class="flex items-center gap-3 px-4 py-2.5 rounded-lg text-slate-300 hover:bg-slate-800 transition">
                    <span>ğŸ“…</span> ì˜ˆì•½ ê´€ë¦¬
                </a>
                <a href="inbox.html" class="flex items-center gap-3 px-4 py-2.5 rounded-lg text-slate-300 hover:bg-slate-800 transition">
                    <span>ğŸ’¬</span> ì¸ë°•ìŠ¤
                </a>
                <a href="campaigns.html" class="flex items-center gap-3 px-4 py-2.5 rounded-lg bg-pink-600 text-white font-medium">
                    <span>ğŸ“¢</span> ìº í˜ì¸
                </a>
            </nav>
            <div class="p-6 border-t border-slate-800">
                <div class="flex items-center justify-between">
                    <p class="text-sm font-medium text-white">Demo User</p>
                    <button onclick="logout()" class="p-2 hover:bg-slate-800 rounded-lg transition">ğŸšª</button>
                </div>
            </div>
        </aside>

        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="h-16 bg-slate-900 border-b border-slate-800 px-6 flex items-center justify-between shrink-0">
                <div>
                    <h2 class="text-xl font-bold text-white">ğŸ“¢ ìº í˜ì¸ ê´€ë¦¬</h2>
                    <p class="text-xs text-slate-400">ì—¬ëŸ¬ í¬ìŠ¤íŠ¸ë¥¼ ìº í˜ì¸ìœ¼ë¡œ ë¬¶ì–´ì„œ ê´€ë¦¬í•˜ì„¸ìš”</p>
                </div>
                <button onclick="showCreateModal()" class="px-4 py-2 bg-pink-600 hover:bg-pink-700 text-white rounded-lg font-medium transition text-sm">
                    + ìƒˆ ìº í˜ì¸
                </button>
            </header>

            <main class="flex-1 overflow-y-auto p-6 space-y-4" id="campaignsList">
                <!-- Campaigns loaded here -->
            </main>
        </div>
    </div>

    <!-- Create/Edit Campaign Modal -->
    <div id="campaignModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-slate-800 border border-slate-700 rounded-xl max-w-2xl w-full max-h-screen overflow-y-auto">
            <div class="p-6 border-b border-slate-700 sticky top-0 bg-slate-800">
                <h3 class="text-xl font-bold text-white" id="modalTitle">ìƒˆ ìº í˜ì¸ ë§Œë“¤ê¸°</h3>
            </div>

            <form id="campaignForm" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">ìº í˜ì¸ëª…</label>
                    <input type="text" id="campaignName" placeholder="ì˜ˆ: ë´„ ì‹ ìƒí’ˆ ì¶œì‹œ" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2.5 text-white placeholder-slate-500 focus:border-pink-500 focus:outline-none">
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">ì„¤ëª…</label>
                    <textarea id="campaignDesc" placeholder="ìº í˜ì¸ì— ëŒ€í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" class="w-full h-24 bg-slate-700 border border-slate-600 rounded-lg px-4 py-2.5 text-white placeholder-slate-500 focus:border-pink-500 focus:outline-none resize-none"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">ëŒ€ìƒ í”Œë«í¼</label>
                    <div class="space-y-2">
                        <label class="flex items-center gap-2">
                            <input type="checkbox" value="instagram" class="platformCheckbox w-4 h-4">
                            <span class="text-sm text-slate-300">Instagram</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" value="facebook" class="platformCheckbox w-4 h-4">
                            <span class="text-sm text-slate-300">Facebook</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" value="twitter" class="platformCheckbox w-4 h-4">
                            <span class="text-sm text-slate-300">Twitter</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" value="tiktok" class="platformCheckbox w-4 h-4">
                            <span class="text-sm text-slate-300">TikTok</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" value="linkedin" class="platformCheckbox w-4 h-4">
                            <span class="text-sm text-slate-300">LinkedIn</span>
                        </label>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">ì‹œì‘ ë‚ ì§œ</label>
                        <input type="date" id="campaignStart" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2.5 text-white focus:border-pink-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">ì¢…ë£Œ ë‚ ì§œ</label>
                        <input type="date" id="campaignEnd" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2.5 text-white focus:border-pink-500 focus:outline-none">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">ìƒíƒœ</label>
                    <select id="campaignStatus" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2.5 text-white focus:border-pink-500 focus:outline-none">
                        <option value="active">ì§„í–‰ ì¤‘</option>
                        <option value="paused">ì¼ì‹œ ì¤‘ì§€</option>
                        <option value="completed">ì™„ë£Œ</option>
                    </select>
                </div>

                <div class="flex gap-3 justify-end pt-4 border-t border-slate-700">
                    <button type="button" onclick="closeCampaignModal()" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-slate-100 rounded-lg">
                        ì·¨ì†Œ
                    </button>
                    <button type="submit" class="px-4 py-2 bg-pink-600 hover:bg-pink-700 text-white rounded-lg font-medium">
                        ì €ì¥í•˜ê¸°
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        requireAuth();
        let editingCampaignId = null;

        async function init() {
            loadCampaigns();
        }

        async function loadCampaigns() {
            try {
                const result = await apiFetch('/api/sns/campaigns').then(r => r.json());
                const campaigns = result.campaigns || [];
                const container = document.getElementById('campaignsList');

                if (campaigns.length === 0) {
                    container.innerHTML = '<div class="text-slate-400 text-center py-12">ìº í˜ì¸ì´ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œ ë§Œë“¤ì–´ë³´ì„¸ìš”!</div>';
                    return;
                }

                container.innerHTML = campaigns.map(camp => {
                    const statusColor = camp.status === 'active' ? 'bg-green-900/50 border-green-700' :
                                       camp.status === 'paused' ? 'bg-yellow-900/50 border-yellow-700' :
                                       'bg-slate-800 border-slate-700';
                    const statusLabel = camp.status === 'active' ? 'ì§„í–‰ ì¤‘' :
                                       camp.status === 'paused' ? 'ì¼ì‹œ ì¤‘ì§€' : 'ì™„ë£Œ';

                    return `
                        <div class="bg-slate-800 rounded-lg p-6 border border-slate-700 hover:border-pink-600 transition">
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex-1">
                                    <h3 class="text-lg font-bold text-white">${camp.name}</h3>
                                    <p class="text-sm text-slate-400 mt-1">${camp.description || 'ì„¤ëª… ì—†ìŒ'}</p>
                                </div>
                                <span class="px-3 py-1 bg-slate-700 text-slate-300 text-xs rounded font-medium">${statusLabel}</span>
                            </div>

                            <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
                                <div>
                                    <p class="text-slate-400">ê¸°ê°„</p>
                                    <p class="text-white">${new Date(camp.start_date).toLocaleDateString('ko-KR')} ~ ${new Date(camp.end_date).toLocaleDateString('ko-KR')}</p>
                                </div>
                                <div>
                                    <p class="text-slate-400">í”Œë«í¼</p>
                                    <p class="text-white">${(camp.target_platforms || []).join(', ') || 'ì „ì²´'}</p>
                                </div>
                            </div>

                            <div class="mb-4 p-3 bg-slate-900 rounded-lg">
                                <p class="text-xs text-slate-400">ì—°ê²°ëœ í¬ìŠ¤íŠ¸</p>
                                <p class="text-lg font-bold text-pink-400">${camp.post_count || 0}ê°œ</p>
                            </div>

                            <div class="flex gap-2 justify-end">
                                <button onclick="editCampaign(${camp.id})" class="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded transition">
                                    ìˆ˜ì •
                                </button>
                                <button onclick="deleteCampaign(${camp.id})" class="px-3 py-2 bg-red-600 hover:bg-red-700 text-white text-sm rounded transition">
                                    ì‚­ì œ
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                document.getElementById('campaignsList').innerHTML = '<div class="text-red-400 text-center py-12">ìº í˜ì¸ ë¡œë“œ ì‹¤íŒ¨</div>';
            }
        }

        function showCreateModal() {
            editingCampaignId = null;
            document.getElementById('modalTitle').textContent = 'ìƒˆ ìº í˜ì¸ ë§Œë“¤ê¸°';
            document.getElementById('campaignForm').reset();
            document.getElementById('campaignModal').classList.remove('hidden');
        }

        function closeCampaignModal() {
            document.getElementById('campaignModal').classList.add('hidden');
            editingCampaignId = null;
        }

        async function editCampaign(campaignId) {
            try {
                const result = await apiFetch(`/api/sns/campaigns/${campaignId}`).then(r => r.json());
                const camp = result.campaign;

                document.getElementById('modalTitle').textContent = 'ìº í˜ì¸ ìˆ˜ì •';
                document.getElementById('campaignName').value = camp.name;
                document.getElementById('campaignDesc').value = camp.description || '';
                document.getElementById('campaignStart').value = camp.start_date.split('T')[0];
                document.getElementById('campaignEnd').value = camp.end_date.split('T')[0];
                document.getElementById('campaignStatus').value = camp.status;

                // Set platforms
                document.querySelectorAll('.platformCheckbox').forEach(checkbox => {
                    checkbox.checked = camp.target_platforms.includes(checkbox.value);
                });

                editingCampaignId = campaignId;
                document.getElementById('campaignModal').classList.remove('hidden');
            } catch (error) {
                showError('ìº í˜ì¸ ë¡œë“œ ì‹¤íŒ¨');
            }
        }

        document.getElementById('campaignForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const platforms = Array.from(document.querySelectorAll('.platformCheckbox:checked')).map(c => c.value);
                const payload = {
                    name: document.getElementById('campaignName').value,
                    description: document.getElementById('campaignDesc').value,
                    target_platforms: platforms,
                    start_date: document.getElementById('campaignStart').value,
                    end_date: document.getElementById('campaignEnd').value,
                    status: document.getElementById('campaignStatus').value
                };

                if (editingCampaignId) {
                    await apiFetch(`/api/sns/campaigns/${editingCampaignId}`, {
                        method: 'PUT',
                        body: JSON.stringify(payload)
                    }).then(r => r.json());
                    showSuccess('ìº í˜ì¸ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
                } else {
                    await apiFetch('/api/sns/campaigns', {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    }).then(r => r.json());
                    showSuccess('ìº í˜ì¸ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
                }

                closeCampaignModal();
                loadCampaigns();
            } catch (error) {
                showError('ì €ì¥ ì‹¤íŒ¨: ' + error.message);
            }
        });

        async function deleteCampaign(campaignId) {
            if (!confirm('ì´ ìº í˜ì¸ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì—°ê²°ëœ í¬ìŠ¤íŠ¸ëŠ” ì‚­ì œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤)')) return;
            try {
                await apiFetch(`/api/sns/campaigns/${campaignId}`, {
                    method: 'DELETE'
                }).then(r => r.json());
                showSuccess('ìº í˜ì¸ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!');
                loadCampaigns();
            } catch (error) {
                showError('ì‚­ì œ ì‹¤íŒ¨');
            }
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
