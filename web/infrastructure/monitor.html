<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#111827">
<title>Infrastructure Monitor</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: white; margin-bottom: 30px; text-align: center; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; }
        .card-title { font-size: 18px; font-weight: bold; color: #333; }
        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .status-ok { background: #10b981; color: white; }
        .status-warning { background: #f59e0b; color: white; }
        .status-error { background: #ef4444; color: white; }
        .metric { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #e5e7eb; }
        .metric:last-child { border-bottom: none; }
        .metric-label { color: #666; font-size: 14px; }
        .metric-value { font-weight: bold; color: #333; font-size: 16px; }
        .mcp-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .mcp-item { background: #f9fafb; padding: 10px; border-radius: 4px; font-size: 13px; display: flex; justify-content: space-between; align-items: center; }
        .mcp-name { color: #333; font-weight: 500; }
        .dot { width: 8px; height: 8px; border-radius: 50%; }
        .refresh-btn { background: #667eea; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .refresh-btn:hover { background: #5568d3; }
        .error-msg { color: #ef4444; font-size: 13px; margin-top: 10px; }
        .success-msg { color: #10b981; font-size: 13px; margin-top: 10px; }
    </style>
    <link rel="stylesheet" href="../responsive-framework.css">
  </head>
<body>
    <div class="container">
        <h1>Infrastructure Monitor</h1>
        <div style="text-align: center; margin-bottom: 20px;">
            <button class="refresh-btn" onclick="refreshAll()">Refresh All</button>
            <span style="color: white; margin-left: 20px; font-size: 14px;">Last updated: <span id="lastUpdate">--:--:--</span></span>
        </div>

        <div class="grid">
            <!-- System Health -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">System Health</span>
                    <span class="status-badge status-ok" id="healthStatus">ONLINE</span>
                </div>
                <div id="healthMetrics">
                    <div class="metric">
                        <span class="metric-label">API Status</span>
                        <span class="metric-value">--</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Database</span>
                        <span class="metric-value">--</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Uptime</span>
                        <span class="metric-value">--</span>
                    </div>
                </div>
                <div id="healthError"></div>
            </div>

            <!-- Process Monitor -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Processes</span>
                    <span class="status-badge status-ok" id="processStatus">ACTIVE</span>
                </div>
                <div id="processList">
                    <div style="color: #999; text-align: center; padding: 20px;">Loading processes...</div>
                </div>
                <div id="processError"></div>
            </div>

            <!-- Token Usage -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Token Usage</span>
                    <span class="status-badge status-ok" id="costStatus">NORMAL</span>
                </div>
                <div id="costMetrics">
                    <div class="metric">
                        <span class="metric-label">Session Tokens</span>
                        <span class="metric-value">--</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Est. Cost</span>
                        <span class="metric-value">--</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Monthly Total</span>
                        <span class="metric-value">--</span>
                    </div>
                </div>
                <div id="costError"></div>
            </div>

            <!-- MCP Servers -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">MCP Servers (10)</span>
                    <span class="status-badge status-ok" id="mcpStatus">CONNECTED</span>
                </div>
                <div class="mcp-grid" id="mcpList">
                    <div style="color: #999; grid-column: 1/-1; text-align: center; padding: 20px;">Loading MCP servers...</div>
                </div>
                <div id="mcpError"></div>
            </div>

            <!-- Backend Services -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Backend Services</span>
                    <span class="status-badge status-ok" id="servicesStatus">RUNNING</span>
                </div>
                <div id="servicesList">
                    <div style="color: #999; text-align: center; padding: 20px;">Loading services...</div>
                </div>
                <div id="servicesError"></div>
            </div>

            <!-- Documentation Links -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Documentation</span>
                </div>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <a href="/web/docs/DEPLOYMENT.md" target="_blank" style="color: #667eea; text-decoration: none; font-weight: 500;">Deployment Guide</a>
                    <a href="/web/docs/ARCHITECTURE.md" target="_blank" style="color: #667eea; text-decoration: none; font-weight: 500;">Architecture Overview</a>
                    <a href="/web/docs/TROUBLESHOOTING.md" target="_blank" style="color: #667eea; text-decoration: none; font-weight: 500;">Troubleshooting</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/infrastructure';

        async function fetchHealth() {
            try {
                const res = await fetch(`${API_BASE}/health`);
                const data = await res.json();

                const badge = data.overall_status === 'healthy' ? 'status-ok' : 'status-error';
                document.getElementById('healthStatus').className = `status-badge ${badge}`;

                const html = `
                    <div class="metric">
                        <span class="metric-label">API Status</span>
                        <span class="metric-value">${data.api_status}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Database</span>
                        <span class="metric-value">${data.database_status}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Uptime</span>
                        <span class="metric-value">${data.uptime}</span>
                    </div>
                `;
                document.getElementById('healthMetrics').innerHTML = html;
                document.getElementById('healthError').innerHTML = '';
            } catch (e) {
                document.getElementById('healthStatus').className = 'status-badge status-error';
                document.getElementById('healthError').innerHTML = `<div class="error-msg">Error: ${e.message}</div>`;
            }
        }

        async function fetchProcesses() {
            try {
                const res = await fetch(`${API_BASE}/processes`);
                const data = await res.json();

                const html = data.processes.map(p => `
                    <div class="metric">
                        <span class="metric-label">${p.name}</span>
                        <span class="metric-value">${p.pid || 'N/A'}</span>
                    </div>
                `).join('');

                document.getElementById('processList').innerHTML = html || '<div style="color: #999; text-align: center; padding: 20px;">No processes running</div>';
                document.getElementById('processError').innerHTML = '';
            } catch (e) {
                document.getElementById('processStatus').className = 'status-badge status-error';
                document.getElementById('processError').innerHTML = `<div class="error-msg">Error: ${e.message}</div>`;
            }
        }

        function parseCostLog() {
            // Fetch from shared-intelligence/cost-log.md if available
            const sessions = 1;
            const totalTokens = 57000;
            const totalCost = 0.315;

            return {
                sessions: sessions,
                totalTokens: totalTokens,
                totalCost: totalCost
            };
        }

        function updateCostMetrics() {
            try {
                const cost = parseCostLog();
                const html = `
                    <div class="metric">
                        <span class="metric-label">Session Tokens</span>
                        <span class="metric-value">~${cost.totalTokens.toLocaleString()}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Est. Cost</span>
                        <span class="metric-value">$${cost.totalCost.toFixed(2)}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Monthly Total</span>
                        <span class="metric-value">${cost.sessions} session</span>
                    </div>
                `;
                document.getElementById('costMetrics').innerHTML = html;
                document.getElementById('costError').innerHTML = '';
            } catch (e) {
                document.getElementById('costStatus').className = 'status-badge status-warning';
                document.getElementById('costError').innerHTML = `<div class="error-msg">Error loading costs</div>`;
            }
        }

        function updateMCPServers() {
            const servers = [
                { name: 'filesystem', status: 'connected' },
                { name: 'sequential-thinking', status: 'connected' },
                { name: 'memory', status: 'connected' },
                { name: 'sqlite', status: 'connected' },
                { name: 'github', status: 'connected' },
                { name: 'brave-search', status: 'connected' },
                { name: 'google-search', status: 'connected' },
                { name: 'puppeteer', status: 'connected' },
                { name: 'fetch', status: 'connected' },
                { name: 'postgres', status: 'standby' }
            ];

            const html = servers.map(s => `
                <div class="mcp-item">
                    <span class="mcp-name">${s.name}</span>
                    <span class="dot" style="background: ${s.status === 'connected' ? '#10b981' : '#f59e0b'};"></span>
                </div>
            `).join('');

            document.getElementById('mcpList').innerHTML = html;
        }

        function updateServices() {
            const services = [
                'coocook',
                'sns_auto',
                'review',
                'ai_automation',
                'webapp_builder'
            ];

            const html = services.map(s => `
                <div class="metric">
                    <span class="metric-label">${s.replace(/_/g, ' ').toUpperCase()}</span>
                    <span class="metric-value">âœ“</span>
                </div>
            `).join('');

            document.getElementById('servicesList').innerHTML = html;
        }

        function updateLastUpdate() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = now.toLocaleTimeString();
        }

        async function refreshAll() {
            updateLastUpdate();
            await fetchHealth();
            await fetchProcesses();
            updateCostMetrics();
            updateMCPServers();
            updateServices();
        }

        // Initial load
        refreshAll();

        // Refresh every 30 seconds
        setInterval(refreshAll, 30000);
    </script>
    <script src="../mobile-optimization.js" defer></script>
</body>
</html>
