<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìë™ ì‹ ì²­ ê·œì¹™ â€” SoftFactory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="../platform/api.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .rule-card {
            transition: all 0.2s ease;
        }
        .rule-card:hover {
            border-color: #fbbf24;
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-100">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside class="w-64 bg-slate-900 border-r border-slate-800 flex flex-col shrink-0">
            <div class="p-6 border-b border-slate-800">
                <a href="../platform/dashboard.html" class="flex items-center gap-3">
                    <span class="text-2xl">ğŸ­</span>
                    <div><h1 class="font-bold text-white text-sm">SoftFactory</h1><p class="text-xs text-slate-400">â† Back</p></div>
                </a>
            </div>
            <nav class="flex-1 p-6 space-y-2 overflow-y-auto">
                <p class="text-xs font-semibold text-slate-400 uppercase px-4 mb-3">â­ Review</p>
                <a href="index.html" class="flex items-center gap-3 px-4 py-2.5 rounded-lg text-slate-300 hover:bg-slate-800">ğŸ¯ ìº í˜ì¸ íƒìƒ‰</a>
                <a href="my-campaigns.html" class="flex items-center gap-3 px-4 py-2.5 rounded-lg text-slate-300 hover:bg-slate-800">ğŸ“‹ ë‚´ ì‹ ì²­</a>
                <a href="aggregator.html" class="flex items-center gap-3 px-4 py-2.5 rounded-lg text-slate-300 hover:bg-slate-800">ğŸ”— ì²´í—˜ë‹¨ ëª¨ìŒ</a>
                <a href="accounts.html" class="flex items-center gap-3 px-4 py-2.5 rounded-lg text-slate-300 hover:bg-slate-800">ğŸ‘¤ ê³„ì • ê´€ë¦¬</a>
                <a href="applications.html" class="flex items-center gap-3 px-4 py-2.5 rounded-lg text-slate-300 hover:bg-slate-800">ğŸ“Š ì‹ ì²­ í˜„í™©</a>
                <a href="auto-apply.html" class="flex items-center gap-3 px-4 py-2.5 rounded-lg bg-amber-600 text-white font-medium">âš¡ ìë™ ì‹ ì²­</a>
            </nav>
            <div class="p-6 border-t border-slate-800">
                <div class="flex items-center justify-between">
                    <p class="text-sm font-medium text-white">Demo User</p>
                    <button onclick="logout()" class="p-2 hover:bg-slate-800 rounded-lg">ğŸšª</button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="h-16 bg-slate-900 border-b border-slate-800 px-6 flex items-center justify-between shrink-0">
                <div>
                    <h2 class="text-xl font-bold text-white">âš¡ ìë™ ì‹ ì²­ ê·œì¹™</h2>
                    <p class="text-xs text-slate-400">ì¡°ê±´ì— ë§ëŠ” ê³µê³ ì— ìë™ ì‹ ì²­í•˜ì„¸ìš”</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="runAutoApplyNow()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium text-sm">â–¶ï¸ ì¦‰ì‹œ ì‹¤í–‰</button>
                    <button onclick="openAddRuleModal()" class="px-4 py-2 bg-amber-600 hover:bg-amber-700 text-white rounded-lg font-medium text-sm">+ ê·œì¹™ ì¶”ê°€</button>
                </div>
            </header>

            <main class="flex-1 overflow-y-auto p-6">
                <!-- Info Box -->
                <div class="bg-blue-900 border border-blue-700 rounded-lg p-4 mb-6 text-blue-200 text-sm">
                    <p>ğŸ’¡ ìë™ ì‹ ì²­ ê·œì¹™ì„ ì„¤ì •í•˜ë©´, ì¡°ê±´ì— ë§ëŠ” ì²´í—˜ë‹¨ ê³µê³ ê°€ ì˜¬ë¼ì˜¬ ë•Œë§ˆë‹¤ ìë™ìœ¼ë¡œ ì‹ ì²­ë©ë‹ˆë‹¤. ì£¼ê¸°ì ìœ¼ë¡œ ì²´í¬í•˜ì„¸ìš”!</p>
                </div>

                <!-- Active Rules -->
                <h3 class="text-lg font-bold text-white mb-4">ğŸ“‹ í™œì„± ê·œì¹™</h3>
                <div id="active-rules-container" class="space-y-4 mb-8">
                    <div class="bg-slate-800 border border-slate-700 rounded-lg p-6 animate-pulse">
                        <div class="h-6 bg-slate-700 rounded mb-4 w-1/2"></div>
                        <div class="h-4 bg-slate-700 rounded"></div>
                    </div>
                </div>

                <!-- History -->
                <h3 class="text-lg font-bold text-white mb-4">ğŸ“Š ìµœê·¼ ìë™ì‹ ì²­ ì´ë ¥</h3>
                <div class="bg-slate-800 border border-slate-700 rounded-lg overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-slate-700 border-b border-slate-600">
                                <tr>
                                    <th class="px-6 py-3 text-left text-sm font-semibold text-white">ì œëª©</th>
                                    <th class="px-6 py-3 text-left text-sm font-semibold text-white">ì‚¬ìš© ê³„ì •</th>
                                    <th class="px-6 py-3 text-left text-sm font-semibold text-white">ì‹ ì²­ì¼ì‹œ</th>
                                    <th class="px-6 py-3 text-left text-sm font-semibold text-white">ìƒíƒœ</th>
                                </tr>
                            </thead>
                            <tbody id="history-table" class="divide-y divide-slate-700">
                                <tr>
                                    <td colspan="4" class="px-6 py-8 text-center text-slate-400">ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-4 right-4 bg-green-600 text-white px-4 py-3 rounded-lg shadow-lg hidden"></div>

    <!-- Add Rule Modal -->
    <div id="add-rule-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 overflow-y-auto">
        <div class="bg-slate-800 border border-slate-700 rounded-lg p-6 max-w-2xl w-full mx-4 my-8">
            <h3 class="text-lg font-bold text-white mb-4">ìë™ ì‹ ì²­ ê·œì¹™ ì¶”ê°€</h3>
            <form onsubmit="submitAddRule(event)">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="text-sm text-slate-300 block mb-2">ê·œì¹™ëª… *</label>
                        <input type="text" id="rule-name" placeholder="ì˜ˆ: ë·°í‹° 100k ì´ìƒ" class="w-full bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white placeholder-slate-500 focus:border-amber-500 focus:outline-none text-sm" required>
                    </div>
                    <div>
                        <label class="text-sm text-slate-300 block mb-2">ìµœì†Œ ë³´ìƒê¸ˆì•¡</label>
                        <input type="number" id="min-reward" placeholder="0" class="w-full bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white placeholder-slate-500 focus:border-amber-500 focus:outline-none text-sm" value="0">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="text-sm text-slate-300 block mb-2">ì¹´í…Œê³ ë¦¬ ì„ íƒ</label>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                        <label class="flex items-center gap-2 text-sm text-slate-300">
                            <input type="checkbox" name="category" value="fashion" class="w-4 h-4 rounded"> ğŸ‘— íŒ¨ì…˜
                        </label>
                        <label class="flex items-center gap-2 text-sm text-slate-300">
                            <input type="checkbox" name="category" value="beauty" class="w-4 h-4 rounded"> ğŸ’„ ë·°í‹°
                        </label>
                        <label class="flex items-center gap-2 text-sm text-slate-300">
                            <input type="checkbox" name="category" value="food" class="w-4 h-4 rounded"> ğŸ” ìŒì‹
                        </label>
                        <label class="flex items-center gap-2 text-sm text-slate-300">
                            <input type="checkbox" name="category" value="travel" class="w-4 h-4 rounded"> âœˆï¸ ì—¬í–‰
                        </label>
                        <label class="flex items-center gap-2 text-sm text-slate-300">
                            <input type="checkbox" name="category" value="tech" class="w-4 h-4 rounded"> âŒš ê¸°ìˆ 
                        </label>
                        <label class="flex items-center gap-2 text-sm text-slate-300">
                            <input type="checkbox" name="category" value="home" class="w-4 h-4 rounded"> ğŸ  ìƒí™œ
                        </label>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="text-sm text-slate-300 block mb-2">ìµœëŒ€ ì‹ ì²­ì ë¹„ìœ¨</label>
                    <input type="range" id="max-ratio" min="0" max="1" step="0.1" value="0.5" class="w-full">
                    <p class="text-xs text-slate-400 mt-1">ì‹ ì²­ì ë¹„ìœ¨ì´ <span id="ratio-display">50%</span> ì´í•˜ì¸ ê³µê³ ë§Œ ì‹ ì²­</p>
                </div>

                <div class="mb-6">
                    <label class="flex items-center gap-2 text-sm text-slate-300">
                        <input type="checkbox" id="rule-is-active" checked class="w-4 h-4 rounded">
                        <span>ì¦‰ì‹œ í™œì„±í™”</span>
                    </label>
                </div>

                <div class="flex gap-2">
                    <button type="button" onclick="closeAddRuleModal()" class="flex-1 px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded font-medium">ì·¨ì†Œ</button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-amber-600 hover:bg-amber-700 text-white rounded font-medium">ìƒì„±</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Rule Modal -->
    <div id="edit-rule-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 overflow-y-auto">
        <div class="bg-slate-800 border border-slate-700 rounded-lg p-6 max-w-2xl w-full mx-4 my-8">
            <h3 class="text-lg font-bold text-white mb-4">ê·œì¹™ í¸ì§‘</h3>
            <form onsubmit="submitEditRule(event)">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="text-sm text-slate-300 block mb-2">ê·œì¹™ëª…</label>
                        <input type="text" id="edit-rule-name" class="w-full bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white focus:border-amber-500 focus:outline-none text-sm" required>
                    </div>
                    <div>
                        <label class="text-sm text-slate-300 block mb-2">ìµœì†Œ ë³´ìƒê¸ˆì•¡</label>
                        <input type="number" id="edit-min-reward" class="w-full bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white focus:border-amber-500 focus:outline-none text-sm">
                    </div>
                </div>

                <div class="mb-6">
                    <label class="flex items-center gap-2 text-sm text-slate-300">
                        <input type="checkbox" id="edit-rule-is-active" class="w-4 h-4 rounded">
                        <span>í™œì„±í™”</span>
                    </label>
                </div>

                <div class="flex gap-2">
                    <button type="button" onclick="closeEditRuleModal()" class="flex-1 px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded font-medium">ì·¨ì†Œ</button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-amber-600 hover:bg-amber-700 text-white rounded font-medium">ì €ì¥</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let rules = [];
        let editingRuleId = null;

        // Setup range slider display
        document.addEventListener('DOMContentLoaded', () => {
            const ratioSlider = document.getElementById('max-ratio');
            if (ratioSlider) {
                ratioSlider.addEventListener('input', (e) => {
                    document.getElementById('ratio-display').textContent = Math.round(e.target.value * 100) + '%';
                });
            }
        });

        async function loadRules() {
            try {
                const response = await apiFetch('/api/review/auto-apply/rules');
                const result = await response.json();

                if (!result.success) {
                    showToast('ê·œì¹™ ë¡œë“œ ì‹¤íŒ¨', 'error');
                    return;
                }

                rules = result.data;
                renderRules();
                loadHistory();
            } catch (error) {
                console.error('Error:', error);
                showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
            }
        }

        function renderRules() {
            const container = document.getElementById('active-rules-container');
            const activeRules = rules.filter(r => r.is_active);

            container.innerHTML = '';

            if (activeRules.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-400 py-8">í™œì„± ê·œì¹™ì´ ì—†ìŠµë‹ˆë‹¤</p>';
            } else {
                activeRules.forEach(rule => {
                    const card = document.createElement('div');
                    card.className = 'rule-card bg-slate-800 border border-slate-700 rounded-lg p-4 hover:border-amber-500';
                    card.innerHTML = `
                        <div class="flex items-start justify-between mb-2">
                            <h4 class="font-semibold text-white">${rule.name}</h4>
                            <span class="px-2 py-1 rounded text-xs font-medium bg-green-900 text-green-200">í™œì„±</span>
                        </div>
                        <div class="text-sm text-slate-400 space-y-1 mb-3">
                            ${rule.categories && rule.categories.length > 0 ? `<p>ğŸ“‚ ì¹´í…Œê³ ë¦¬: ${rule.categories.join(', ')}</p>` : ''}
                            <p>ğŸ’° ìµœì†Œë³´ìƒ: ${(rule.min_reward || 0).toLocaleString()}ì›</p>
                            <p>ğŸ“Š ìµœëŒ€ì‹ ì²­ìë¹„ìœ¨: ${(rule.max_applicants_ratio * 100).toFixed(0)}%</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="openEditRuleModal(${rule.id})" class="flex-1 px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm font-medium">âœï¸ í¸ì§‘</button>
                            <button onclick="deleteRule(${rule.id})" class="flex-1 px-3 py-2 bg-red-600 hover:bg-red-700 text-white rounded text-sm font-medium">ğŸ—‘ï¸ ì‚­ì œ</button>
                        </div>
                    `;
                    container.appendChild(card);
                });
            }
        }

        async function loadHistory() {
            // Mock history data - in production would load from backend
            const tbody = document.getElementById('history-table');
            tbody.innerHTML = `
                <tr>
                    <td class="px-6 py-4 text-sm text-white">ë·°í‹° ì„¸ëŸ¼ ì²´í—˜ë‹¨</td>
                    <td class="px-6 py-4 text-sm text-slate-300">Instagram - @demo</td>
                    <td class="px-6 py-4 text-sm text-slate-400">2026-02-25 14:30</td>
                    <td class="px-6 py-4"><span class="px-2 py-1 rounded text-xs font-medium bg-green-900 text-green-200">ì„±ê³µ</span></td>
                </tr>
                <tr>
                    <td class="px-6 py-4 text-sm text-white">íŒ¨ì…˜ ì˜ë¥˜ ì²´í—˜ë‹¨</td>
                    <td class="px-6 py-4 text-sm text-slate-300">Blog - ë‚˜ì˜ë¸”ë¡œê·¸</td>
                    <td class="px-6 py-4 text-sm text-slate-400">2026-02-25 10:15</td>
                    <td class="px-6 py-4"><span class="px-2 py-1 rounded text-xs font-medium bg-yellow-900 text-yellow-200">ëŒ€ê¸°ì¤‘</span></td>
                </tr>
            `;
        }

        function openAddRuleModal() {
            document.getElementById('add-rule-modal').classList.remove('hidden');
            document.getElementById('rule-name').focus();
        }

        function closeAddRuleModal() {
            document.getElementById('add-rule-modal').classList.add('hidden');
            document.getElementById('rule-name').value = '';
            document.getElementById('min-reward').value = '0';
            document.getElementById('rule-is-active').checked = true;
            document.querySelectorAll('#add-rule-modal input[name="category"]').forEach(el => el.checked = false);
        }

        async function submitAddRule(event) {
            event.preventDefault();

            const selectedCategories = Array.from(document.querySelectorAll('#add-rule-modal input[name="category"]:checked'))
                .map(el => el.value);

            const data = {
                name: document.getElementById('rule-name').value,
                categories: selectedCategories,
                min_reward: parseInt(document.getElementById('min-reward').value || 0),
                max_applicants_ratio: parseFloat(document.getElementById('max-ratio').value),
                is_active: document.getElementById('rule-is-active').checked
            };

            try {
                const response = await apiFetch('/api/review/auto-apply/rules', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (result.success) {
                    showToast('ê·œì¹™ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤');
                    closeAddRuleModal();
                    loadRules();
                } else {
                    showToast('ìƒì„± ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), 'error');
                }
            } catch (error) {
                showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
            }
        }

        function openEditRuleModal(ruleId) {
            editingRuleId = ruleId;
            const rule = rules.find(r => r.id === ruleId);
            if (rule) {
                document.getElementById('edit-rule-name').value = rule.name;
                document.getElementById('edit-min-reward').value = rule.min_reward || 0;
                document.getElementById('edit-rule-is-active').checked = rule.is_active;
                document.getElementById('edit-rule-modal').classList.remove('hidden');
            }
        }

        function closeEditRuleModal() {
            document.getElementById('edit-rule-modal').classList.add('hidden');
            editingRuleId = null;
        }

        async function submitEditRule(event) {
            event.preventDefault();

            const data = {
                name: document.getElementById('edit-rule-name').value,
                min_reward: parseInt(document.getElementById('edit-min-reward').value || 0),
                is_active: document.getElementById('edit-rule-is-active').checked
            };

            try {
                const response = await apiFetch(`/api/review/auto-apply/rules/${editingRuleId}`, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (result.success) {
                    showToast('ê·œì¹™ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤');
                    closeEditRuleModal();
                    loadRules();
                } else {
                    showToast('ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), 'error');
                }
            } catch (error) {
                showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
            }
        }

        async function deleteRule(ruleId) {
            if (!confirm('ì •ë§ë¡œ ì´ ê·œì¹™ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const response = await apiFetch(`/api/review/auto-apply/rules/${ruleId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                if (result.success) {
                    showToast('ê·œì¹™ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
                    loadRules();
                } else {
                    showToast('ì‚­ì œ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), 'error');
                }
            } catch (error) {
                showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
            }
        }

        async function runAutoApplyNow() {
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<span>â³ ì§„í–‰ ì¤‘...</span>';

            try {
                const response = await apiFetch('/api/review/auto-apply/run', { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    showToast(`${result.applied_count}ê°œ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤`);
                    loadHistory();
                } else {
                    showToast('ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), 'error');
                }
            } catch (error) {
                showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'â–¶ï¸ ì¦‰ì‹œ ì‹¤í–‰';
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg text-white ${type === 'error' ? 'bg-red-600' : 'bg-green-600'}`;
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        // Initial load
        loadRules();
    </script>
</body>
</html>
