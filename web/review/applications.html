<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#020617">
    <title>Reward & Settlement ‚Äî ReviewEverything Platinum</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <script src="../platform/api.js"></script>
    <style>
        :root {
            --primary-amber: #f59e0b;
            --primary-dark: #020617;
            --glass-bg: rgba(15, 23, 42, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: #020617;
            color: #f8fafc;
        }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.65rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .status-applied {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .status-selected {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.2);
        }

        .status-rejected {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .status-completed {
            background: rgba(168, 85, 247, 0.1);
            color: #a855f7;
            border: 1px solid rgba(168, 85, 247, 0.2);
        }

        .scroll-hide::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>

<body class="overflow-hidden bg-slate-950">
    <div class="flex h-screen overflow-hidden">
        <!-- Platinum Sidebar -->
        <aside class="w-72 glass-panel border-r border-slate-800/50 flex flex-col z-50">
            <div class="p-8 border-b border-slate-800/50">
                <div class="flex items-center gap-4">
                    <div
                        class="w-12 h-12 rounded-2xl bg-gradient-to-tr from-amber-600 to-amber-400 p-0.5 shadow-lg shadow-amber-900/20">
                        <div class="w-full h-full bg-slate-950 rounded-2xl flex items-center justify-center text-2xl">‚ö°
                        </div>
                    </div>
                    <div>
                        <h1 class="font-black text-white text-lg tracking-tight uppercase">ReviewEngine</h1>
                        <p class="text-[10px] text-amber-500 font-bold tracking-[0.2em]">PLATINUM EDITION</p>
                    </div>
                </div>
            </div>

            <nav class="flex-1 p-6 space-y-1.5 overflow-y-auto scroll-hide">
                <p class="text-[10px] font-black text-slate-500 uppercase px-4 mb-4 tracking-widest text-slate-400">
                    Finance Center</p>
                <a href="index.html"
                    class="flex items-center gap-4 px-5 py-3.5 rounded-xl text-slate-400 font-medium hover:bg-slate-800/50 hover:text-white transition-all">
                    <span>üéØ</span><span class="text-sm">AI ÌÉêÏÉâ</span>
                </a>
                <a href="aggregator.html"
                    class="flex items-center gap-4 px-5 py-3.5 rounded-xl text-slate-400 font-medium hover:bg-slate-800/50 hover:text-white transition-all">
                    <span>üîó</span><span class="text-sm">ÏïåÌåå ÏïÑÏπ¥Ïù¥Î∏å</span>
                </a>
                <div class="pt-8">
                    <p class="text-[10px] font-black text-slate-500 uppercase px-4 mb-4 tracking-widest text-slate-400">
                        Ledger</p>
                    <a href="applications.html"
                        class="flex items-center gap-4 px-5 py-3.5 rounded-xl bg-amber-500/10 text-amber-500 font-bold border-l-2 border-amber-500 transition-all">
                        <span>üìä</span><span class="text-sm">Î¶¨ÏõåÎìú Ï†ïÏÇ∞ (Settlements)</span>
                    </a>
                </div>
            </nav>
        </aside>

        <div class="flex-1 flex flex-col overflow-hidden relative">
            <header class="h-24 px-10 flex items-center justify-between shrink-0 z-40">
                <div>
                    <h2 class="text-3xl font-black text-white tracking-tight text-glow">Reward & Settlement</h2>
                    <p class="text-xs text-slate-400 mt-1 font-medium">Track your earnings and pending review
                        completions</p>
                </div>
                <div class="flex items-center gap-6">
                    <div
                        class="flex items-center gap-2 bg-indigo-500/10 border border-indigo-500/20 px-6 py-3 rounded-2xl">
                        <span class="text-xs font-black text-indigo-400 uppercase tracking-widest">Total Earned</span>
                        <span class="text-xl font-black text-white">‚Ç©1,245,600</span>
                    </div>
                </div>
            </header>

            <main class="flex-1 overflow-y-auto p-10 pt-0 scroll-hide">
                <!-- Status & Filter Grid -->
                <div class="grid grid-cols-4 gap-6 mb-12">
                    <div class="glass-panel p-6 rounded-[2rem] border-slate-800/50 flex flex-col items-center">
                        <p id="stat-total" class="text-3xl font-black text-white">0</p>
                        <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest mt-2">Total Apps</p>
                    </div>
                    <div class="glass-panel p-6 rounded-[2rem] border-slate-800/50 flex flex-col items-center">
                        <p id="stat-selected" class="text-3xl font-black text-green-500">0</p>
                        <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest mt-2">Active Winners
                        </p>
                    </div>
                    <div class="glass-panel p-6 rounded-[2rem] border-slate-800/50 flex flex-col items-center">
                        <p id="stat-pending" class="text-3xl font-black text-blue-500">0</p>
                        <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest mt-2">Under Review</p>
                    </div>
                    <div class="glass-panel p-6 rounded-[2rem] border-slate-800/50 flex flex-col items-center">
                        <p id="stat-rate" class="text-3xl font-black text-amber-500">0%</p>
                        <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest mt-2">Approval ROI</p>
                    </div>
                </div>

                <!-- Main Ledger Table -->
                <div class="glass-panel rounded-[2.5rem] border-slate-800/50 overflow-hidden bg-slate-900/40 mb-12">
                    <div class="p-8 flex items-center justify-between border-b border-white/5">
                        <h3 class="text-lg font-black text-white">Application Ledger</h3>
                        <div class="flex gap-4">
                            <select id="status-filter" onchange="loadApplications()"
                                class="bg-slate-950 border border-slate-800 rounded-xl px-4 py-2 text-xs font-bold text-slate-300 focus:outline-none focus:border-amber-500">
                                <option value="">Filter Status</option>
                                <option value="applied">Reviewing</option>
                                <option value="selected">Winner</option>
                                <option value="rejected">Rejected</option>
                                <option value="completed">Completed</option>
                            </select>
                            <button onclick="loadApplications()"
                                class="px-6 py-2 bg-slate-800 hover:bg-slate-700 text-white font-black text-xs rounded-xl transition-all">REFRESH
                                LEDGER</button>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="bg-slate-950/50 border-b border-slate-800/50">
                                    <th
                                        class="px-10 py-5 text-left font-black text-[10px] text-slate-500 uppercase tracking-widest">
                                        Target Campaign</th>
                                    <th
                                        class="px-10 py-5 text-left font-black text-[10px] text-slate-500 uppercase tracking-widest">
                                        Asset Node</th>
                                    <th
                                        class="px-10 py-5 text-left font-black text-[10px] text-slate-500 uppercase tracking-widest">
                                        Settlement</th>
                                    <th
                                        class="px-10 py-5 text-left font-black text-[10px] text-slate-500 uppercase tracking-widest">
                                        Status</th>
                                    <th
                                        class="px-10 py-5 text-left font-black text-[10px] text-slate-500 uppercase tracking-widest">
                                        Link</th>
                                </tr>
                            </thead>
                            <tbody id="applications-table" class="divide-y divide-slate-800/50">
                                <!-- Data will be injected here -->
                                <tr class="animate-pulse h-20">
                                    <td colspan="5" class="px-10 py-5 text-center text-slate-600 text-xs">Synchronizing
                                        ledger entries...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Advanced Pagination -->
                <div class="flex justify-center items-center gap-6 pb-20">
                    <button id="prev-btn" onclick="previousPage()"
                        class="w-12 h-12 glass-panel rounded-2xl flex items-center justify-center text-slate-500 hover:text-white transition-all">‚Üê</button>
                    <span id="page-info" class="text-xs font-black text-slate-500 uppercase tracking-widest">1 /
                        1</span>
                    <button id="next-btn" onclick="nextPage()"
                        class="w-12 h-12 glass-panel rounded-2xl flex items-center justify-center text-slate-500 hover:text-white transition-all">‚Üí</button>
                </div>
            </main>
        </div>
    </div>

    <!-- Notification Engine -->
    <div id="toast"
        class="fixed bottom-10 left-10 glass-panel bg-slate-900 border-green-500/50 px-6 py-3 rounded-xl shadow-2xl opacity-0 translate-y-20 transition-all pointer-events-none">
        <p id="toast-message" class="text-xs font-black text-white"></p>
    </div>

    <script>
        requireAuth();
        let currentPage = 1;
        let totalPages = 1;

        async function loadApplications() {
            try {
                const statusFilter = document.getElementById('status-filter').value;
                const params = new URLSearchParams();
                if (statusFilter) params.append('status', statusFilter);
                params.append('page', currentPage);
                params.append('limit', 10);

                const response = await apiFetch(`/api/review/applications?${params.toString()}`);
                const result = await response.json();

                if (result.success) {
                    renderTable(result.data.applications);
                    updateStats(result.data);
                    totalPages = Math.ceil(result.data.total / 10);
                    document.getElementById('page-info').textContent = `${currentPage} / ${totalPages}`;
                }
            } catch (err) { console.error('Ledger Load Error:', err); }
        }

        function renderTable(apps) {
            const tbody = document.getElementById('applications-table');
            tbody.innerHTML = '';

            if (apps.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-10 py-12 text-center text-slate-500 font-bold uppercase text-[10px] tracking-[0.2em]">No entries located in current filter</td></tr>';
                return;
            }

            apps.forEach(app => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-slate-800/30 transition-all group';
                row.innerHTML = `
                    <td class="px-10 py-6">
                        <p class="font-black text-white line-clamp-1 group-hover:text-amber-500 transition-colors">${app.listing_title || 'N/A'}</p>
                        <p class="text-[10px] text-slate-600 font-bold mt-1 uppercase">${new Date(app.applied_at).toLocaleDateString()}</p>
                    </td>
                    <td class="px-10 py-6 text-xs text-slate-400 font-bold">${app.account_name || '@unknown'}</td>
                    <td class="px-10 py-6 text-sm font-black text-slate-200">‚Ç©${(app.reward_value || 0).toLocaleString()}</td>
                    <td class="px-10 py-6">
                        <span class="status-badge status-${app.status}">${getStatusLabel(app.status)}</span>
                    </td>
                    <td class="px-10 py-6">
                        <a href="${app.review_url}" target="_blank" class="w-10 h-10 glass-panel rounded-xl flex items-center justify-center text-sm hover:border-amber-500 hover:text-amber-500 transition-all">
                             ${app.review_url ? 'üîó' : '‚Äî'}
                        </a>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function getStatusLabel(s) {
            const labels = { 'applied': 'Reviewing', 'selected': 'Winner', 'rejected': 'Miss', 'completed': 'Paid' };
            return labels[s] || s;
        }

        function updateStats(data) {
            document.getElementById('stat-total').textContent = data.total;
            // Other stats logic based on filtered data...
            const sel = data.applications.filter(a => a.status === 'selected').length;
            document.getElementById('stat-selected').textContent = sel;
            document.getElementById('stat-pending').textContent = data.applications.filter(a => a.status === 'applied').length;
            document.getElementById('stat-rate').textContent = data.total > 0 ? ((sel / data.total) * 100).toFixed(0) + '%' : '0%';
        }

        function previousPage() { if (currentPage > 1) { currentPage--; loadApplications(); } }
        function nextPage() { if (currentPage < totalPages) { currentPage++; loadApplications(); } }

        document.addEventListener('DOMContentLoaded', loadApplications);
    </script>
</body>

</html>