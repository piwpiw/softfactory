<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹ ì²­ í˜„í™© â€” SoftFactory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="../platform/api.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .status-applied { background-color: #1e40af; color: #dbeafe; }
        .status-selected { background-color: #059669; color: #d1fae5; }
        .status-rejected { background-color: #991b1b; color: #fee2e2; }
        .status-completed { background-color: #7c3aed; color: #ede9fe; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside class="w-64 bg-slate-900 border-r border-slate-800 flex flex-col shrink-0">
            <div class="p-6 border-b border-slate-800">
                <a href="../platform/dashboard.html" class="flex items-center gap-3">
                    <span class="text-2xl">ğŸ­</span>
                    <div><h1 class="font-bold text-white text-sm">SoftFactory</h1><p class="text-xs text-slate-400">â† Back</p></div>
                </a>
            </div>
            <nav class="flex-1 p-6 space-y-2 overflow-y-auto">
                <p class="text-xs font-semibold text-slate-400 uppercase px-4 mb-3">â­ Review</p>
                <a href="index.html" class="flex items-center gap-3 px-4 py-2.5 rounded-lg text-slate-300 hover:bg-slate-800">ğŸ¯ ìº í˜ì¸ íƒìƒ‰</a>
                <a href="my-campaigns.html" class="flex items-center gap-3 px-4 py-2.5 rounded-lg text-slate-300 hover:bg-slate-800">ğŸ“‹ ë‚´ ì‹ ì²­</a>
                <a href="aggregator.html" class="flex items-center gap-3 px-4 py-2.5 rounded-lg text-slate-300 hover:bg-slate-800">ğŸ”— ì²´í—˜ë‹¨ ëª¨ìŒ</a>
                <a href="accounts.html" class="flex items-center gap-3 px-4 py-2.5 rounded-lg text-slate-300 hover:bg-slate-800">ğŸ‘¤ ê³„ì • ê´€ë¦¬</a>
                <a href="applications.html" class="flex items-center gap-3 px-4 py-2.5 rounded-lg bg-amber-600 text-white font-medium">ğŸ“Š ì‹ ì²­ í˜„í™©</a>
                <a href="auto-apply.html" class="flex items-center gap-3 px-4 py-2.5 rounded-lg text-slate-300 hover:bg-slate-800">âš¡ ìë™ ì‹ ì²­</a>
            </nav>
            <div class="p-6 border-t border-slate-800">
                <div class="flex items-center justify-between">
                    <p class="text-sm font-medium text-white">Demo User</p>
                    <button onclick="logout()" class="p-2 hover:bg-slate-800 rounded-lg">ğŸšª</button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="h-16 bg-slate-900 border-b border-slate-800 px-6 flex items-center justify-between shrink-0">
                <div>
                    <h2 class="text-xl font-bold text-white">ğŸ“Š ì‹ ì²­ í˜„í™©</h2>
                    <p class="text-xs text-slate-400">ë‹¹ì‹ ì˜ ì²´í—˜ë‹¨ ì‹ ì²­ í˜„í™©ì„ í™•ì¸í•˜ì„¸ìš”</p>
                </div>
            </header>

            <main class="flex-1 overflow-y-auto p-6">
                <!-- Filters -->
                <div class="bg-slate-800 border border-slate-700 rounded-lg p-4 mb-6">
                    <h3 class="font-semibold text-white mb-4">ğŸ” í•„í„°</h3>
                    <div class="flex gap-4 flex-wrap">
                        <select id="status-filter" onchange="loadApplications()" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm focus:border-amber-500 focus:outline-none">
                            <option value="">ëª¨ë“  ìƒíƒœ</option>
                            <option value="applied">ğŸ” ê²€í† ì¤‘</option>
                            <option value="selected">âœ… ì„ ì •</option>
                            <option value="rejected">âŒ íƒˆë½</option>
                            <option value="completed">âœ”ï¸ ì™„ë£Œ</option>
                        </select>
                        <input type="date" id="date-from" onchange="loadApplications()" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm focus:border-amber-500 focus:outline-none">
                        <input type="date" id="date-to" onchange="loadApplications()" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm focus:border-amber-500 focus:outline-none">
                        <button onclick="loadApplications()" class="px-4 py-2 bg-amber-600 hover:bg-amber-700 text-white rounded font-medium text-sm">ê²€ìƒ‰</button>
                    </div>
                </div>

                <!-- Stats -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-slate-800 border border-slate-700 rounded-lg p-4">
                        <p class="text-slate-400 text-sm mb-2">ì´ ì‹ ì²­</p>
                        <p id="stat-total" class="text-2xl font-bold text-white">0</p>
                    </div>
                    <div class="bg-slate-800 border border-slate-700 rounded-lg p-4">
                        <p class="text-slate-400 text-sm mb-2">ì„ ì •</p>
                        <p id="stat-selected" class="text-2xl font-bold text-green-400">0</p>
                    </div>
                    <div class="bg-slate-800 border border-slate-700 rounded-lg p-4">
                        <p class="text-slate-400 text-sm mb-2">ê²€í† ì¤‘</p>
                        <p id="stat-pending" class="text-2xl font-bold text-blue-400">0</p>
                    </div>
                    <div class="bg-slate-800 border border-slate-700 rounded-lg p-4">
                        <p class="text-slate-400 text-sm mb-2">ì„ ì •ë¥ </p>
                        <p id="stat-rate" class="text-2xl font-bold text-amber-400">0%</p>
                    </div>
                </div>

                <!-- Table -->
                <div class="bg-slate-800 border border-slate-700 rounded-lg overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-slate-700 border-b border-slate-600">
                                <tr>
                                    <th class="px-6 py-3 text-left text-sm font-semibold text-white">ì œëª©</th>
                                    <th class="px-6 py-3 text-left text-sm font-semibold text-white">ê³„ì •</th>
                                    <th class="px-6 py-3 text-left text-sm font-semibold text-white">ì‹ ì²­ì¼</th>
                                    <th class="px-6 py-3 text-left text-sm font-semibold text-white">ìƒíƒœ</th>
                                    <th class="px-6 py-3 text-left text-sm font-semibold text-white">ë³´ìƒ</th>
                                    <th class="px-6 py-3 text-left text-sm font-semibold text-white">ì•¡ì…˜</th>
                                </tr>
                            </thead>
                            <tbody id="applications-table" class="divide-y divide-slate-700">
                                <tr class="hover:bg-slate-700/50">
                                    <td colspan="6" class="px-6 py-8 text-center text-slate-400">ë¡œë“œ ì¤‘...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Pagination -->
                <div class="mt-6 flex justify-center items-center gap-4">
                    <button id="prev-btn" onclick="previousPage()" class="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded font-medium text-sm">â† ì´ì „</button>
                    <span id="page-info" class="text-slate-300 font-medium">1 / 1</span>
                    <button id="next-btn" onclick="nextPage()" class="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded font-medium text-sm">ë‹¤ìŒ â†’</button>
                </div>
            </main>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-4 right-4 bg-green-600 text-white px-4 py-3 rounded-lg shadow-lg hidden"></div>

    <!-- Modal -->
    <div id="modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-slate-800 border border-slate-700 rounded-lg p-6 max-w-md w-full mx-4">
            <h3 id="modal-title" class="text-lg font-bold text-white mb-4"></h3>
            <p id="modal-content" class="text-slate-300 mb-6"></p>
            <div id="modal-review-url" class="mb-6 hidden">
                <label class="text-sm text-slate-300 block mb-2">ë¦¬ë·° URL</label>
                <input type="url" id="review-url-input" placeholder="https://..." class="w-full bg-slate-700 border border-slate-600 rounded px-3 py-2 text-white text-sm">
            </div>
            <div class="flex gap-2">
                <button onclick="closeModal()" class="flex-1 px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded font-medium">ì·¨ì†Œ</button>
                <button id="modal-confirm" onclick="confirmModal()" class="flex-1 px-4 py-2 bg-amber-600 hover:bg-amber-700 text-white rounded font-medium">í™•ì¸</button>
            </div>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let totalPages = 1;
        let modalCallback = null;
        let selectedApplicationId = null;

        async function loadApplications() {
            const statusFilter = document.getElementById('status-filter').value;
            const dateFrom = document.getElementById('date-from').value;
            const dateTo = document.getElementById('date-to').value;

            const params = new URLSearchParams();
            if (statusFilter) params.append('status', statusFilter);
            if (dateFrom) params.append('date_from', dateFrom);
            if (dateTo) params.append('date_to', dateTo);
            params.append('page', currentPage);
            params.append('limit', 10);

            try {
                const response = await apiFetch(`/api/review/applications?${params.toString()}`);
                const result = await response.json();

                if (!result.success) {
                    showToast('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨', 'error');
                    return;
                }

                const tbody = document.getElementById('applications-table');
                tbody.innerHTML = '';

                if (result.data.applications.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-slate-400">ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                } else {
                    result.data.applications.forEach(app => {
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-slate-700/50 transition-colors';
                        row.innerHTML = `
                            <td class="px-6 py-4 text-sm text-white">${app.listing_title || 'N/A'}</td>
                            <td class="px-6 py-4 text-sm text-slate-300">${app.account_name || 'Account'}</td>
                            <td class="px-6 py-4 text-sm text-slate-400">${new Date(app.applied_at).toLocaleDateString('ko-KR')}</td>
                            <td class="px-6 py-4">
                                <span class="status-badge status-${app.status}">${getStatusLabel(app.status)}</span>
                            </td>
                            <td class="px-6 py-4 text-sm font-semibold text-amber-400">${(app.reward_value || 0).toLocaleString()}ì›</td>
                            <td class="px-6 py-4">
                                <div class="flex gap-2">
                                    ${app.status === 'selected' ? `<button onclick="markComplete(${app.id})" class="px-3 py-1 bg-green-600 hover:bg-green-700 text-white rounded text-xs font-medium">ì™„ë£Œ</button>` : ''}
                                    ${app.status === 'selected' ? `<button onclick="openReviewModal(${app.id})" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs font-medium">ë¦¬ë·°</button>` : ''}
                                    <a href="${app.review_url}" target="_blank" ${app.review_url ? '' : 'style="pointer-events: none; opacity: 0.5;"'} class="px-3 py-1 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded text-xs font-medium">ë§í¬</a>
                                </div>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                }

                // Update stats
                const totalApps = result.data.total;
                const selectedCount = result.data.applications.filter(a => a.status === 'selected').length;
                const pendingCount = result.data.applications.filter(a => a.status === 'applied').length;
                const selectRate = totalApps > 0 ? (selectedCount / totalApps * 100).toFixed(1) : 0;

                document.getElementById('stat-total').textContent = totalApps;
                document.getElementById('stat-selected').textContent = selectedCount;
                document.getElementById('stat-pending').textContent = pendingCount;
                document.getElementById('stat-rate').textContent = selectRate + '%';

                totalPages = Math.ceil(result.data.total / 10);
                updatePagination();
            } catch (error) {
                console.error('Error:', error);
                showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
            }
        }

        function getStatusLabel(status) {
            const labels = {
                'applied': 'ê²€í† ì¤‘',
                'selected': 'ì„ ì •',
                'rejected': 'íƒˆë½',
                'completed': 'ì™„ë£Œ'
            };
            return labels[status] || status;
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                loadApplications();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function nextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                loadApplications();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function updatePagination() {
            document.getElementById('page-info').textContent = `${currentPage} / ${totalPages}`;
            document.getElementById('prev-btn').disabled = currentPage === 1;
            document.getElementById('next-btn').disabled = currentPage === totalPages;
        }

        function openReviewModal(applicationId) {
            selectedApplicationId = applicationId;
            document.getElementById('modal-title').textContent = 'ë¦¬ë·° URL ë“±ë¡';
            document.getElementById('modal-content').textContent = 'ì‹ ì²­ì„ ì™„ë£Œí–ˆë‚˜ìš”? ë¦¬ë·° URLì„ ë“±ë¡í•´ì£¼ì„¸ìš”.';
            document.getElementById('modal-review-url').classList.remove('hidden');
            document.getElementById('modal').classList.remove('hidden');
            modalCallback = () => submitReview(applicationId);
        }

        async function submitReview(applicationId) {
            const reviewUrl = document.getElementById('review-url-input').value;
            if (!reviewUrl) {
                showToast('URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
                return;
            }

            try {
                const response = await apiFetch(`/api/review/applications/${applicationId}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        status: 'completed',
                        review_url: reviewUrl,
                        review_posted_at: new Date().toISOString()
                    })
                });

                const result = await response.json();
                if (result.success) {
                    showToast('ë¦¬ë·°ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');
                    closeModal();
                    loadApplications();
                } else {
                    showToast('ë“±ë¡ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), 'error');
                }
            } catch (error) {
                showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
            }
        }

        async function markComplete(applicationId) {
            try {
                const response = await apiFetch(`/api/review/applications/${applicationId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ status: 'completed' })
                });

                const result = await response.json();
                if (result.success) {
                    showToast('ì™„ë£Œ í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤');
                    loadApplications();
                } else {
                    showToast('ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), 'error');
                }
            } catch (error) {
                showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
            }
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
            document.getElementById('review-url-input').value = '';
            document.getElementById('modal-review-url').classList.add('hidden');
            modalCallback = null;
        }

        function confirmModal() {
            if (modalCallback) modalCallback();
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg text-white ${type === 'error' ? 'bg-red-600' : 'bg-green-600'}`;
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        // Initial load
        loadApplications();
    </script>
</body>
</html>
