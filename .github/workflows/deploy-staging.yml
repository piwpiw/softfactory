name: Deploy — Staging

on:
  push:
    branches: [develop]
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag to deploy (default: branch SHA)'
        required: false
        default: ''

env:
  REGISTRY: docker.io
  IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/softfactory

# Prevent concurrent staging deploys
concurrency:
  group: deploy-staging
  cancel-in-progress: false

jobs:
  # ---------------------------------------------------------------------------
  # STAGE 1: Build & push Docker image to Docker Hub
  # ---------------------------------------------------------------------------
  build-and-push:
    name: Build & Push Image
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.meta.outputs.image_tag }}
      image_full: ${{ steps.meta.outputs.image_full }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Compute image metadata
        id: meta
        run: |
          SHORT_SHA="${GITHUB_SHA::8}"
          IMAGE_TAG="staging-${SHORT_SHA}"
          IMAGE_FULL="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}"
          echo "image_tag=${IMAGE_TAG}" >> "$GITHUB_OUTPUT"
          echo "image_full=${IMAGE_FULL}"  >> "$GITHUB_OUTPUT"
          echo "IMAGE_TAG=${IMAGE_TAG}" >> "$GITHUB_ENV"
          echo "IMAGE_FULL=${IMAGE_FULL}" >> "$GITHUB_ENV"

      - name: Build and push staging image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.prod
          push: true
          tags: |
            ${{ steps.meta.outputs.image_full }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:staging-latest
          labels: |
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}

  # ---------------------------------------------------------------------------
  # STAGE 2: Deploy to staging server via SSH
  # ---------------------------------------------------------------------------
  deploy:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build-and-push
    environment: staging

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          IMAGE_FULL: ${{ needs.build-and-push.outputs.image_full }}
          IMAGE_TAG: ${{ needs.build-and-push.outputs.image_tag }}
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          GIT_SHA: ${{ github.sha }}
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          port: 22
          envs: IMAGE_FULL,IMAGE_TAG,DOCKER_USERNAME,DOCKER_PASSWORD,GIT_SHA
          script: |
            set -e

            echo "[deploy] Pulling image: $IMAGE_FULL"
            echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin

            docker pull "$IMAGE_FULL"

            echo "[deploy] Tagging as current"
            docker tag "$IMAGE_FULL" softfactory:current

            echo "[deploy] Stopping old container (if any)"
            docker stop softfactory-staging 2>/dev/null || true
            docker rm   softfactory-staging 2>/dev/null || true

            echo "[deploy] Starting new container"
            docker run -d \
              --name softfactory-staging \
              --restart unless-stopped \
              -p 9001:9000 \
              --env-file /opt/softfactory/staging/.env \
              -e GIT_SHA="$GIT_SHA" \
              -e IMAGE_TAG="$IMAGE_TAG" \
              -v /opt/softfactory/staging/logs:/app/logs \
              softfactory:current

            echo "[deploy] Waiting for health check (30s)..."
            sleep 30

            echo "[deploy] Verifying health"
            curl -sf http://localhost:9001/health || (docker logs softfactory-staging --tail=50 && exit 1)

            echo "[deploy] Staging deployment complete: $IMAGE_TAG"

  # ---------------------------------------------------------------------------
  # STAGE 3: Integration tests against staging
  # ---------------------------------------------------------------------------
  integration-tests:
    name: Integration Tests (Staging)
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install test dependencies
        run: |
          pip install requests pytest pytest-timeout

      - name: Wait for staging to warm up
        run: |
          echo "Waiting 15 seconds for staging to stabilise..."
          sleep 15

      - name: Run smoke tests against staging
        env:
          STAGING_URL: http://${{ secrets.STAGING_HOST }}:9001
          STAGING_DEMO_TOKEN: demo_token
        run: |
          python -m pytest tests/integration/ \
            -v \
            --tb=short \
            --timeout=60 \
            -m "smoke or integration" \
            --ignore=tests/integration/test_cross_validation.py \
            -k "not slow" \
            || true

      - name: Run API smoke test (inline)
        env:
          BASE_URL: http://${{ secrets.STAGING_HOST }}:9001
        run: |
          python - <<'EOF'
          import sys, os, urllib.request, json

          base = os.environ["BASE_URL"]

          def check(label, url, expect_status=200):
              try:
                  req = urllib.request.Request(url)
                  resp = urllib.request.urlopen(req, timeout=10)
                  code = resp.getcode()
                  ok = (code == expect_status)
                  print(f"{'OK' if ok else 'FAIL'} [{code}] {label}: {url}")
                  return ok
              except Exception as e:
                  print(f"FAIL [ERR] {label}: {e}")
                  return False

          results = [
              check("Health",          f"{base}/health"),
              check("Platform API",    f"{base}/api/platform/stats"),
          ]

          failed = results.count(False)
          print(f"\n{len(results) - failed}/{len(results)} checks passed")
          sys.exit(1 if failed > 0 else 0)
          EOF

  # ---------------------------------------------------------------------------
  # STAGE 4: Telegram notification
  # ---------------------------------------------------------------------------
  notify:
    name: Notify via Telegram
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy, integration-tests]
    if: always()

    steps:
      - name: Send Telegram notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID:   ${{ secrets.TELEGRAM_CHAT_ID }}
          IMAGE_TAG: ${{ needs.build-and-push.outputs.image_tag }}
          DEPLOY_STATUS: ${{ needs.deploy.result }}
          TEST_STATUS:   ${{ needs.integration-tests.result }}
          ACTOR:         ${{ github.actor }}
          REF:           ${{ github.ref_name }}
          SHA:           ${{ github.sha }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          if [[ "$DEPLOY_STATUS" == "success" ]]; then
            ICON="✅"
            STATUS_TEXT="DEPLOYED"
          else
            ICON="❌"
            STATUS_TEXT="FAILED"
          fi

          if [[ "$TEST_STATUS" == "success" ]]; then
            TEST_ICON="✅"
          else
            TEST_ICON="⚠️"
          fi

          MESSAGE="${ICON} *SoftFactory Staging ${STATUS_TEXT}*

          Branch: \`${REF}\`
          Image: \`${IMAGE_TAG}\`
          Commit: \`${SHA::8}\`
          Actor: ${ACTOR}

          Tests: ${TEST_ICON} ${TEST_STATUS}

          [View Run](${RUN_URL})"

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d parse_mode="Markdown" \
            -d disable_web_page_preview="true" \
            -d text="${MESSAGE}"
