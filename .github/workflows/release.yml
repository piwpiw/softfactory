name: Release & Versioning

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  semantic-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      pull-requests: write
    outputs:
      new-release-published: ${{ steps.semantic.outputs.new_release_published }}
      new-release-version: ${{ steps.semantic.outputs.new_release_version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'npm'

      - name: Install semantic-release
        run: |
          npm install -g semantic-release @semantic-release/changelog @semantic-release/git @semantic-release/github

      - name: Run semantic-release
        id: semantic
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          semantic-release

  generate-changelog:
    needs: semantic-release
    runs-on: ubuntu-latest
    if: needs.semantic-release.outputs.new-release-published == 'true'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install gitpython requests

      - name: Generate changelog
        run: |
          python scripts/generate_changelog.py ${{ needs.semantic-release.outputs.new-release-version }}

      - name: Commit changelog
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add CHANGELOG.md
          git commit -m "docs: update changelog for ${{ needs.semantic-release.outputs.new-release-version }}" || true
          git push

  create-release-notes:
    needs: [semantic-release, generate-changelog]
    runs-on: ubuntu-latest
    if: needs.semantic-release.outputs.new-release-published == 'true'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Generate release notes
        uses: actions/github-script@v6
        with:
          script: |
            const tag = '${{ needs.semantic-release.outputs.new-release-version }}';
            const response = await github.rest.repos.generateReleaseNotes({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: `v${tag}`,
            });

            await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: `v${tag}`,
              name: `Release ${tag}`,
              body: response.data.body,
              draft: false,
              prerelease: false,
            });

  build-artifacts:
    needs: semantic-release
    if: needs.semantic-release.outputs.new-release-published == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            artifact: softfactory-linux-amd64.tar.gz
          - os: macos-latest
            artifact: softfactory-macos-amd64.zip
          - os: windows-latest
            artifact: softfactory-windows-amd64.zip
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build artifact (${{ matrix.os }})
        run: |
          pyinstaller --onefile --name softfactory backend/app.py

      - name: Package artifact
        shell: bash
        run: |
          if [[ "${{ matrix.os }}" == "ubuntu-latest" ]]; then
            tar -czf ${{ matrix.artifact }} dist/
          else
            7z a ${{ matrix.artifact }} dist/
          fi

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ matrix.artifact }}
          tag_name: v${{ needs.semantic-release.outputs.new-release-version }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-docker:
    needs: semantic-release
    if: needs.semantic-release.outputs.new-release-published == 'true'
    runs-on: ubuntu-latest
    permissions:
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ github.repository }}:v${{ needs.semantic-release.outputs.new-release-version }}
            ghcr.io/${{ github.repository }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  notify-release:
    needs: [semantic-release, create-release-notes, publish-docker]
    runs-on: ubuntu-latest
    if: needs.semantic-release.outputs.new-release-published == 'true'
    steps:
      - name: Send Slack notification
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              text: `ðŸŽ‰ New Release: v${{ needs.semantic-release.outputs.new-release-version }}`,
              blocks: [
                {
                  type: 'header',
                  text: {
                    type: 'plain_text',
                    text: 'ðŸ“¦ Release Published'
                  }
                },
                {
                  type: 'section',
                  fields: [
                    {
                      type: 'mrkdwn',
                      text: `*Version:*\nv${{ needs.semantic-release.outputs.new-release-version }}`
                    },
                    {
                      type: 'mrkdwn',
                      text: `*Commit:*\n${{ github.sha }}`
                    }
                  ]
                },
                {
                  type: 'actions',
                  elements: [
                    {
                      type: 'button',
                      text: {
                        type: 'plain_text',
                        text: 'View Release'
                      },
                      url: `${{ github.server_url }}/${{ github.repository }}/releases/tag/v${{ needs.semantic-release.outputs.new-release-version }}`
                    }
                  ]
                }
              ]
            }
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        continue-on-error: true
